# 광고 엔진 테이블 설계

## 📋 목차
1. [데이터베이스 아키텍처 개요](#-데이터베이스-아키텍처-개요)
2. [테이블 분류 및 구성](#-테이블-분류-및-구성)
3. [마스터 데이터 테이블](#-마스터-데이터-테이블)
4. [잔액 관리 테이블](#-잔액-관리-테이블)
5. [운영 관리 테이블](#-운영-관리-테이블)
6. [성과 분석 테이블](#-성과-분석-테이블)
7. [시스템 설정 테이블](#-시스템-설정-테이블)
8. [파티셔닝 및 성능 최적화](#-파티셔닝-및-성능-최적화)

### 필수 조건 

- 모든 테이블은 제외 없이 공통필드를 전부 갖는다.
```
    activated       TINYINT                                        DEFAULT 1                   NOT NULL COMMENT '활성화 여부 (1:활성, 0:비활성)',
    created_at      DATETIME                                       DEFAULT NULL                COMMENT '등록일시',
    updated_at      DATETIME                                       DEFAULT NULL                COMMENT '수정일시',
    created_user_id BIGINT                                         DEFAULT NULL                COMMENT '생성자 ID',
    updated_user_id BIGINT                                         DEFAULT NULL                COMMENT '수정자 ID',
```
- 카디널리티가 낮은 필드는 인덱스를 만들지않는다.
- FK 만들지 않는다. 연결 고리는 논리적으로만 갖고있는다.

---

## 🏗️ 데이터베이스 아키텍처 개요

### ERD (Entity Relationship Diagram)

```mermaid
erDiagram
    %% 마스터 데이터 (4개)
    ad_advertisers ||--o{ ad_campaigns : "광고주가 여러 캠페인 소유"
    ad_campaigns ||--o{ ad_placement_bids : "캠페인이 여러 입찰 설정 보유"
    ad_campaigns ||--o{ ad_daily_budget_trackings : "캠페인별 일일 예산 추적"
    ad_campaigns ||--o{ ad_performance_metrics_realtime : "캠페인별 실시간 성과"
    ad_campaigns ||--o{ ad_event_summaries_daily : "캠페인별 일일 요약"
    
    %% 상품 관련 연결
    ad_products_meta ||--o{ ad_placement_bids : "상품별 입찰 설정"
    ad_products_meta ||--o{ ad_product_status_caches : "상품별 성과 캐시"
    ad_products_meta ||--o{ ad_impression_pricings : "상품별 노출 가격"
    ad_products_meta ||--o{ ad_performance_metrics_realtime : "상품별 실시간 성과"
    ad_products_meta ||--o{ ad_event_summaries_daily : "상품별 일일 요약"
    
    %% 잔액 관리 (2개)
    ad_advertisers ||--|| ad_balances : "광고주별 잔액 정보"
    ad_advertisers ||--o{ ad_balance_histories : "광고주별 잔액 이력"
    
    %% 시스템 설정 (4개)
    ad_category_hierarchies ||--o{ ad_category_hierarchies : "상위-하위 카테고리"
    ad_engine_parameters ||--o{ ad_engine_parameter_histories : "파라미터 변경 이력"
    
    %% 마스터 데이터 테이블 (4개)
    ad_advertisers {
        bigint id PK "광고주 ID"
        varchar advertiser_name "광고주명"
        varchar business_type "사업 유형"
        varchar status "상태"
        decimal credit_limit "신용 한도"
        decimal daily_budget "일일 예산"
        tinyint activated "활성화 여부"
        datetime created_at "등록일시"
        datetime updated_at "수정일시"
        bigint created_user_id "생성자 ID"
        bigint updated_user_id "수정자 ID"
    }
    
    ad_campaigns {
        bigint id PK "캠페인 ID"
        bigint advertiser_id FK "광고주 ID"
        varchar campaign_name "캠페인명"
        varchar campaign_type "과금 방식"
        varchar status "캠페인 상태"
        date start_date "시작일"
        date end_date "종료일"
        decimal daily_budget "일일 예산"
        decimal total_budget "총 예산"
        json target_regions "타겟 지역"
        tinyint activated "활성화 여부"
        datetime created_at "등록일시"
        datetime updated_at "수정일시"
        bigint created_user_id "생성자 ID"
        bigint updated_user_id "수정자 ID"
    }
    
    ad_products_meta {
        bigint product_id PK "상품 ID"
        decimal quality_score "품질 점수"
        varchar ad_status "광고 상태"
        varchar category_path "카테고리 경로"
        tinyint activated "활성화 여부"
        datetime created_at "등록일시"
        datetime updated_at "수정일시"
        bigint created_user_id "생성자 ID"
        bigint updated_user_id "수정자 ID"
    }
    
    ad_placement_bids {
        bigint id PK "입찰 ID"
        bigint campaign_id FK "캠페인 ID"
        bigint product_id FK "상품 ID"
        varchar placement "광고 영역"
        decimal bid_price "입찰가"
        decimal max_daily_spend "일일 최대 소진"
        varchar status "입찰 상태"
        tinyint activated "활성화 여부"
        datetime created_at "등록일시"
        datetime updated_at "수정일시"
        bigint created_user_id "생성자 ID"
        bigint updated_user_id "수정자 ID"
    }
    
    %% 잔액 관리 테이블 (2개)
    
    ad_balances {
        bigint advertiser_id PK,FK "광고주 ID"
        decimal current_balance "현재 잔액"
        decimal reserved_balance "예약 잔액"
        decimal daily_spent "일일 사용"
        decimal monthly_spent "월 사용"
        date last_spent_date "최종 사용일"
        decimal alert_threshold "알림 임계값"
        boolean auto_charge_enabled "자동 충전"
        decimal auto_charge_amount "자동 충전 금액"
        tinyint activated "활성화 여부"
        datetime created_at "등록일시"
        datetime updated_at "수정일시"
        bigint created_user_id "생성자 ID"
        bigint updated_user_id "수정자 ID"
    }
    
    ad_balance_histories {
        bigint id PK "이력 ID"
        bigint advertiser_id FK "광고주 ID"
        varchar transaction_type "거래 유형"
        decimal amount "거래 금액"
        decimal balance_before "거래 전 잔액"
        decimal balance_after "거래 후 잔액"
        varchar reference_id "참조 ID"
        varchar reference_type "참조 유형"
        text description "거래 설명"
        tinyint activated "활성화 여부"
        datetime created_at "등록일시"
        datetime updated_at "수정일시"
        bigint created_user_id "생성자 ID"
        bigint updated_user_id "수정자 ID"
    }
    
    %% 운영 관리 테이블 (3개)
    
    ad_daily_budget_trackings {
        bigint id PK "추적 ID"
        bigint campaign_id FK "캠페인 ID"
        date track_date "추적 일자"
        decimal daily_budget "일일 예산"
        decimal spent_amount "사용 금액"
        bigint impression_count "노출 수"
        bigint click_count "클릭 수"
        bigint conversion_count "전환 수"
        tinyint activated "활성화 여부"
        datetime created_at "등록일시"
        datetime updated_at "수정일시"
        bigint created_user_id "생성자 ID"
        bigint updated_user_id "수정자 ID"
    }
    
    ad_product_status_caches {
        bigint product_id PK,FK "상품 ID"
        decimal ctr_score "CTR 점수"
        decimal cvr_score "CVR 점수"
        decimal popularity_score "인기도 점수"
        timestamp last_impression "최종 노출"
        timestamp last_click "최종 클릭"
        timestamp last_conversion "최종 전환"
        bigint impression_count_1h "1시간 노출"
        bigint click_count_1h "1시간 클릭"
        bigint impression_count_24h "24시간 노출"
        bigint click_count_24h "24시간 클릭"
        bigint conversion_count_24h "24시간 전환"
        timestamp last_threshold_check "마지막 임계값 체크"
        tinyint activated "활성화 여부"
        datetime created_at "등록일시"
        datetime updated_at "수정일시"
        bigint created_user_id "생성자 ID"
        bigint updated_user_id "수정자 ID"
    }
    
    ad_impression_pricings {
        varchar impression_id PK "노출 고유 식별자"
        varchar device_id "디바이스 식별자"
        varchar session_id "세션 식별자"
        bigint campaign_id FK "캠페인 ID"
        bigint product_id FK "상품 ID"
        varchar placement "광고 영역"
        decimal bid_price "입찰가"
        decimal calculated_price "산정된 적용가"
        int ad_rank "광고 순위"
        decimal algorithm_score "알고리즘 점수"
        varchar experiment_key "실험 키"
        varchar experiment_var "실험 변수"
        timestamp impression_time "노출 시간"
        timestamp expires_at "만료 시간"
        tinyint activated "활성화 여부"
        datetime created_at "등록일시"
        datetime updated_at "수정일시"
        bigint created_user_id "생성자 ID"
        bigint updated_user_id "수정자 ID"
    }
    
    %% 성과 분석 테이블 (2개)
    
    ad_performance_metrics_realtime {
        bigint id PK "메트릭 ID"
        bigint campaign_id FK "캠페인 ID"
        bigint product_id FK "상품 ID"
        varchar placement "광고 영역"
        timestamp metric_hour "메트릭 시간"
        bigint impression_count "노출 수"
        bigint click_count "클릭 수"
        bigint conversion_count "전환 수"
        decimal total_spend "총 소진"
        decimal total_revenue "총 매출"
        decimal avg_cpc "평균 CPC"
        decimal ctr "클릭률"
        decimal cvr "전환율"
        decimal roas "광고 수익률"
        tinyint activated "활성화 여부"
        datetime created_at "등록일시"
        datetime updated_at "수정일시"
        bigint created_user_id "생성자 ID"
        bigint updated_user_id "수정자 ID"
    }
    
    ad_event_summaries_daily {
        bigint id PK "요약 ID"
        date summary_date "요약 날짜"
        bigint campaign_id FK "캠페인 ID"
        bigint product_id FK "상품 ID"
        varchar placement "광고 영역"
        bigint impression_count "노출 수"
        bigint click_count "클릭 수"
        bigint conversion_count "전환 수"
        decimal total_spend "총 소진"
        decimal total_revenue "총 매출"
        bigint unique_users "순 사용자"
        varchar s3_path "S3 경로"
        tinyint activated "활성화 여부"
        datetime created_at "등록일시"
        datetime updated_at "수정일시"
        bigint created_user_id "생성자 ID"
        bigint updated_user_id "수정자 ID"
    }
    
    %% 시스템 설정 테이블 (4개)
    
    ad_category_defense_stats {
        bigint id PK "통계 ID"
        varchar category_path "카테고리 경로"
        tinyint category_level "카테고리 레벨"
        decimal avg_ctr "평균 CTR"
        decimal min_ctr "최소 CTR"
        decimal avg_cvr "평균 CVR"
        decimal min_cvr "최소 CVR"
        bigint sample_count "샘플 수"
        varchar calculation_period "계산 기간"
        timestamp last_calculated "마지막 계산"
        tinyint activated "활성화 여부"
        datetime created_at "등록일시"
        datetime updated_at "수정일시"
        bigint created_user_id "생성자 ID"
        bigint updated_user_id "수정자 ID"
    }
    
    ad_category_hierarchies {
        bigint id PK "카테고리 ID"
        varchar category_name "카테고리명"
        tinyint category_level "카테고리 레벨"
        bigint parent_id FK "상위 카테고리"
        varchar category_path "카테고리 경로"
        int display_order "표시 순서"
        boolean is_active "기존 활성화"
        tinyint activated "활성화 여부"
        datetime created_at "등록일시"
        datetime updated_at "수정일시"
        bigint created_user_id "생성자 ID"
        bigint updated_user_id "수정자 ID"
    }
    
    ad_engine_parameters {
        bigint id PK "파라미터 ID"
        varchar parameter_name "파라미터명"
        decimal parameter_value "파라미터 값"
        text description "설명"
        varchar placement "적용 영역"
        boolean is_active "기존 활성화"
        timestamp effective_from "적용 시작"
        timestamp effective_until "적용 종료"
        varchar created_by "기존 생성자"
        tinyint activated "활성화 여부"
        datetime created_at "등록일시"
        datetime updated_at "수정일시"
        bigint created_user_id "생성자 ID"
        bigint updated_user_id "수정자 ID"
    }
    
    ad_engine_parameter_histories {
        bigint id PK "이력 ID"
        bigint parameter_id FK "파라미터 ID"
        decimal old_value "변경 전 값"
        decimal new_value "변경 후 값"
        text change_reason "변경 사유"
        varchar changed_by "기존 변경자"
        timestamp effective_from "적용 시작"
        tinyint activated "활성화 여부"
        datetime created_at "등록일시"
        datetime updated_at "수정일시"
        bigint created_user_id "생성자 ID"
        bigint updated_user_id "수정자 ID"
    }
```

---

## 📊 테이블 분류 및 구성

> **🎯 설계 철학**: 데이터 무결성, 성능 최적화, 확장성, 유지보수성
> 
> **핵심 개선**: 실시간 비즈니스 로직은 DB, 분석용 원시 데이터는 S3

| 분류 | 테이블 수 | 테이블명 | 주요 목적 |
|------|-----------|----------|-----------|
| **마스터 데이터** | 4개 | `ad_advertisers`, `ad_campaigns`, `ad_products_meta`, `ad_placement_bids` | 광고주, 캠페인, 상품, 입찰 기본 정보 |
| **잔액 관리** | 2개 | `ad_balances`, `ad_balance_histories` | 실시간 잔액 추적 및 이력 관리 |
| **운영 관리** | 3개 | `ad_daily_budget_trackings`, `ad_product_status_caches`, `ad_impression_pricings` | 예산 추적, 성과 캐시, 노출 가격 매핑 |
| **성과 분석** | 2개 | `ad_performance_metrics_realtime`, `ad_event_summaries_daily` | 실시간 성과 지표 및 일별 요약 |
| **시스템 설정** | 4개 | `ad_category_defense_stats`, `ad_category_hierarchies`, `ad_engine_parameters`, `ad_engine_parameter_histories` | 방어값 통계, 카테고리 계층, 엔진 파라미터 |

**총 15개 테이블**로 구성된 효율적인 데이터 아키텍처

---

## 🎯 마스터 데이터 테이블

### 1. 광고주 관리 (ad_advertisers) -> **거래처 테이블에서 써야 됨**
> **목적**: 광고주 정보 및 상태 관리
> **비즈니스 요구사항**: 광고주 승인/중단, 연락처 관리, 과금 타입 설정

**📋 데이터 Flow:**
- **INSERT**: 광고주 회원가입 → 서류 심사 → 승인 후 광고주 마스터 생성
- **UPDATE**: 
  - 광고주 정보 변경 (회사명, 연락처, 사업유형 수정)
  - 상태 변경 (ACTIVE ↔ INACTIVE ↔ SUSPENDED)
  - 신용한도/일일예산 한도 조정 (관리자 권한)
- **DELETE**: 실제 삭제 없음, activated=0으로 비활성화 처리

```sql
CREATE TABLE ad_advertisers (
    id              BIGINT                                         PRIMARY KEY AUTO_INCREMENT COMMENT '광고주 고유 식별자',
    advertiser_name VARCHAR(255)                                   NOT NULL                    COMMENT '광고주 회사명/브랜드명',
    business_type   VARCHAR(20)                                    NOT NULL                    COMMENT '사업 유형 (BRAND/COMMERCE/SERVICE)',
    status          VARCHAR(20)                                    DEFAULT 'ACTIVE'            COMMENT '광고주 상태 (ACTIVE/INACTIVE/SUSPENDED)',
    credit_limit    DECIMAL(15,2)                                  DEFAULT 0.00                COMMENT '신용 한도 (원)',
    daily_budget    DECIMAL(15,2)                                  DEFAULT 0.00                COMMENT '일일 예산 한도 (원)',
    activated       TINYINT                                        DEFAULT 1                   NOT NULL COMMENT '활성화 여부 (1:활성, 0:비활성)',
    created_at      DATETIME                                       DEFAULT NULL                COMMENT '등록일시',
    updated_at      DATETIME                                       DEFAULT NULL                COMMENT '수정일시',
    created_user_id BIGINT                                         DEFAULT NULL                COMMENT '생성자 ID',
    updated_user_id BIGINT                                         DEFAULT NULL                COMMENT '수정자 ID',
    
    INDEX idx_status_type (status, business_type)
) ENGINE=InnoDB COMMENT='광고주 마스터 정보 - 광고 계정 기본 정보 관리';
```

### 2. 캠페인 관리 (ad_campaigns)
> **목적**: 광고 캠페인 설정 및 상태 관리
> **비즈니스 요구사항**: 캠페인 기간, 예산, 타겟팅 설정

**📋 데이터 Flow:**
- **INSERT**: 
  - 광고주가 캠페인 등록 → 4단계 프로세스 → PENDING 상태로 생성
  - 관리자 심사 완료 → ACTIVE 상태로 변경 → campaign-events 토픽 발행
- **UPDATE**: 
  - 캠페인 정보 수정 (예산, 기간, 타겟팅 변경) → campaign-events 토픽 발행
  - 상태 변경 (ACTIVE ↔ PAUSED ↔ ENDED) → RTB 재계산 트리거
  - 일일예산 초과 시 시스템 자동 PAUSED 처리
- **DELETE**: 논리적 삭제만 허용, ENDED 상태로 변경

```sql
CREATE TABLE ad_campaigns (
    id               BIGINT                                         PRIMARY KEY AUTO_INCREMENT COMMENT '캠페인 고유 식별자',
    advertiser_id    BIGINT                                         NOT NULL                    COMMENT '광고주 식별자 (FK)',
    campaign_name    VARCHAR(100)                                   NOT NULL                    COMMENT '캠페인명',
    campaign_type    VARCHAR(20)                                    DEFAULT 'CPC'               COMMENT '과금 방식 (CPC/CPM/CPA)',
    status           VARCHAR(20)                                    DEFAULT 'PENDING'           COMMENT '캠페인 상태 (ACTIVE/PAUSED/ENDED/PENDING)',
    start_date       DATE                                           NOT NULL                    COMMENT '캠페인 시작일',
    end_date         DATE                                                                       COMMENT '캠페인 종료일 (NULL=무제한)',
    daily_budget     DECIMAL(15,2)                                  NOT NULL                    COMMENT '일일 예산 (원)',
    total_budget     DECIMAL(15,2)                                                              COMMENT '총 예산 (원, NULL=무제한)',
    target_gender    VARCHAR(20)                                    DEFAULT 'ALL'               COMMENT '타겟 성별 (ALL/MALE/FEMALE)',
    target_age_min   INT                                            DEFAULT 0                   COMMENT '타겟 최소 연령',
    target_age_max   INT                                            DEFAULT 100                 COMMENT '타겟 최대 연령',
    target_regions   JSON                                                                       COMMENT '타겟 지역 목록 (JSON 배열)',
    activated        TINYINT                                        DEFAULT 1                   NOT NULL COMMENT '활성화 여부 (1:활성, 0:비활성)',
    created_at       DATETIME                                       DEFAULT NULL                COMMENT '등록일시',
    updated_at       DATETIME                                       DEFAULT NULL                COMMENT '수정일시',
    created_user_id  BIGINT                                         DEFAULT NULL                COMMENT '생성자 ID',
    updated_user_id  BIGINT                                         DEFAULT NULL                COMMENT '수정자 ID',
    
    FOREIGN KEY (advertiser_id) REFERENCES ad_advertisers(id),
    INDEX idx_advertiser_status (advertiser_id, status),
    INDEX idx_status_dates (status, start_date, end_date)
) ENGINE=InnoDB COMMENT='광고 캠페인 정보';
```

### 3. 상품 메타데이터 (ad_products_meta)
> **목적**: 광고 상품의 메타 정보 및 카테고리 관리
> **비즈니스 요구사항**: 상품 분류, 검색 최적화, 성과 분석

**📋 데이터 Flow:**
- **INSERT**: 
  - 새 상품 등록 시 기본 품질점수(1.00)로 생성
  - 카테고리 경로 자동 계산 후 저장
- **UPDATE**: 
  - 상품 카테고리 변경 → category_path 업데이트 → RTB 재계산
  - 품질점수 조정 (성과 기반 또는 관리자 수동 조정)
  - 광고상태 변경 (ACTIVE ↔ PAUSED ↔ BLOCKED) → RTB 필터링 영향
- **DELETE**: 실제 삭제 없음, ad_status='BLOCKED'으로 처리

```sql
CREATE TABLE ad_products_meta (
    product_id      BIGINT                                         PRIMARY KEY                 COMMENT '상품 식별자 (기존 상품 테이블 참조)',
    quality_score   DECIMAL(3,2)                                   DEFAULT 1.00                COMMENT '광고 품질 점수 (0.00~5.00)',
    ad_status       VARCHAR(20)                                    DEFAULT 'ACTIVE'            COMMENT '광고 가능 상태 (ACTIVE/PAUSED/BLOCKED)',
    category_path   VARCHAR(200)                                                               COMMENT '카테고리 경로 캐시 (성능 최적화용)',
    activated       TINYINT                                        DEFAULT 1                   NOT NULL COMMENT '활성화 여부 (1:활성, 0:비활성)',
    created_at      DATETIME                                       DEFAULT NULL                COMMENT '등록일시',
    updated_at      DATETIME                                       DEFAULT NULL                COMMENT '수정일시',
    created_user_id BIGINT                                         DEFAULT NULL                COMMENT '생성자 ID',
    updated_user_id BIGINT                                         DEFAULT NULL                COMMENT '수정자 ID',
    
    INDEX idx_quality_score (quality_score DESC),
    INDEX idx_ad_status (ad_status),
    INDEX idx_category_path (category_path)
    CHECK (quality_score >= 0.00 AND quality_score <= 5.00)
) ENGINE=InnoDB COMMENT='광고 상품 메타정보';
```

### 4. 배치 입찰가 (ad_placement_bids)
> **목적**: 광고 영역별 입찰가 설정 관리
> **비즈니스 요구사항**: 영역별 차등 입찰, 시간대별 조정

**📋 데이터 Flow:**
- **INSERT**: 
  - 캠페인 등록 4단계 중 '입찰가/예산 설정' 단계에서 생성
  - 영역별(HOME/CATEGORY/PRODUCT_DETAIL/SEARCH) 입찰가 설정
- **UPDATE**: 
  - 입찰가 조정 → campaign-events 토픽 발행 → RTB 재계산
  - 일일 최대 소진액 변경 → 예산 모니터링 기준 업데이트
  - 상태 변경 (ACTIVE ↔ PAUSED) → 해당 영역 광고 노출 제어
- **DELETE**: 논리적 삭제, status='PAUSED'로 변경

```sql
CREATE TABLE ad_placement_bids (
    id              BIGINT                                         PRIMARY KEY AUTO_INCREMENT COMMENT '입찰 설정 고유 식별자',
    campaign_id     BIGINT                                         NOT NULL                    COMMENT '캠페인 식별자 (FK)',
    product_id      BIGINT                                         NOT NULL                    COMMENT '상품 식별자 (기존 상품 테이블 참조)',
    placement       VARCHAR(20)                                    NOT NULL                    COMMENT '광고 영역 (HOME/CATEGORY/PRODUCT_DETAIL/SEARCH)',
    bid_price       DECIMAL(10,2)                                  NOT NULL                    COMMENT '입찰가 (원) - 광고 알고리즘의 B(a,i)',
    max_daily_spend DECIMAL(15,2)                                                              COMMENT '일일 최대 소진 금액 (원)',
    status          VARCHAR(20)                                    DEFAULT 'ACTIVE'            COMMENT '입찰 상태 (ACTIVE/PAUSED)',
    activated       TINYINT                                        DEFAULT 1                   NOT NULL COMMENT '활성화 여부 (1:활성, 0:비활성)',
    created_at      DATETIME                                       DEFAULT NULL                COMMENT '등록일시',
    updated_at      DATETIME                                       DEFAULT NULL                COMMENT '수정일시',
    created_user_id BIGINT                                         DEFAULT NULL                COMMENT '생성자 ID',
    updated_user_id BIGINT                                         DEFAULT NULL                COMMENT '수정자 ID',
    
    FOREIGN KEY (campaign_id) REFERENCES ad_campaigns(id),
    UNIQUE KEY uk_campaign_product_placement (campaign_id, product_id, placement),
    INDEX idx_placement_status (placement, status),
    INDEX idx_bid_price (bid_price DESC)
) ENGINE=InnoDB COMMENT='영역별 상품 입찰가 설정';
```

### 5. 잔액 관리 (ad_balances)
> **목적**: 실시간 잔액 체크 및 차감
> **비즈니스 요구사항**: 잔액 부족 시 광고 중단, 실시간 차감 처리

**📋 데이터 Flow:**
- **INSERT**: 광고주 승인 완료 시 초기 잔액 0원으로 생성
- **UPDATE**: 
  - **충전**: 카드/계좌이체 충전 → current_balance 증가
  - **차감**: Worker가 클릭 이벤트 처리 → current_balance 차감 (50ms 내)
  - **보상**: compensation-events 처리 → 중복 클릭 금액 복구
  - **일일집계**: 매일 자정 daily_spent 초기화, monthly_spent 누적
  - **자동충전**: current_balance < alert_threshold 시 자동 충전 실행
- **DELETE**: 삭제 불가, 광고주 비활성화 시에도 잔액 보존

```sql
CREATE TABLE ad_balances (
    advertiser_id     BIGINT                                        PRIMARY KEY                 COMMENT '광고주 식별자 (FK)',
    current_balance   DECIMAL(15,2)                                 NOT NULL DEFAULT 0.00       COMMENT '현재 사용 가능 잔액 (원)',
    reserved_balance  DECIMAL(15,2)                                 NOT NULL DEFAULT 0.00       COMMENT '진행중 광고 예약 금액 (원)',
    daily_spent       DECIMAL(15,2)                                 NOT NULL DEFAULT 0.00       COMMENT '금일 사용 금액 (원)',
    monthly_spent     DECIMAL(15,2)                                 NOT NULL DEFAULT 0.00       COMMENT '당월 사용 금액 (원)',
    last_spent_date   DATE                                                                       COMMENT '최종 사용일',
    alert_threshold   DECIMAL(15,2)                                 DEFAULT 10000.00             COMMENT '잔액 부족 알림 임계값 (원)',
    auto_charge_enabled BOOLEAN                                     DEFAULT FALSE                COMMENT '자동 충전 활성화 여부',
    auto_charge_amount DECIMAL(15,2)                                DEFAULT 0.00                 COMMENT '자동 충전 금액 (원)',
    activated         TINYINT                                        DEFAULT 1                   NOT NULL COMMENT '활성화 여부 (1:활성, 0:비활성)',
    created_at        DATETIME                                       DEFAULT NULL                COMMENT '등록일시',
    updated_at        DATETIME                                       DEFAULT NULL                COMMENT '수정일시',
    created_user_id   BIGINT                                         DEFAULT NULL                COMMENT '생성자 ID',
    updated_user_id   BIGINT                                         DEFAULT NULL                COMMENT '수정자 ID',
    
    FOREIGN KEY (advertiser_id) REFERENCES ad_advertisers(id),
    INDEX idx_balance_threshold (current_balance, alert_threshold),
    INDEX idx_last_spent_date (last_spent_date),
    CHECK (current_balance >= 0),
    CHECK (reserved_balance >= 0)
) ENGINE=InnoDB COMMENT='광고주 잔액 관리';
```

### 6. 잔액 이력 (ad_balance_histories)
> **목적**: 잔액 변동 이력 추적 및 감사
> **비즈니스 요구사항**: 충전/차감 내역 추적, 회계 감사

**📋 데이터 Flow:**
- **INSERT**: 
  - 모든 잔액 변동 시 자동 생성 (충전/차감/보상/조정)
  - transaction_type별 자동 분류 (CHARGE/SPEND/REFUND/ADJUSTMENT)
  - balance_before/after 자동 계산하여 저장
- **UPDATE**: 이력 데이터는 수정 불가 (Audit 목적)
- **DELETE**: 삭제 불가, 영구 보관 (법적 요구사항)

```sql
CREATE TABLE ad_balance_histories (
    id               BIGINT                                         PRIMARY KEY AUTO_INCREMENT COMMENT '잔액 변경 이력 고유 식별자',
    advertiser_id    BIGINT                                         NOT NULL                    COMMENT '광고주 식별자 (FK)',
    transaction_type VARCHAR(20)                                    NOT NULL                    COMMENT '거래 유형 (CHARGE/SPEND/REFUND/ADJUSTMENT)',
    amount           DECIMAL(15,2)                                  NOT NULL                    COMMENT '거래 금액 (원)',
    balance_before   DECIMAL(15,2)                                  NOT NULL                    COMMENT '거래 전 잔액 (원)',
    balance_after    DECIMAL(15,2)                                  NOT NULL                    COMMENT '거래 후 잔액 (원)',
    reference_id     VARCHAR(50)                                                                COMMENT '참조 ID (주문ID, 캠페인ID 등)',
    reference_type   VARCHAR(20)                                                                COMMENT '참조 유형 (CAMPAIGN/ORDER/MANUAL/AUTO_CHARGE)',
    description      TEXT                                                                       COMMENT '거래 상세 설명',
    activated       TINYINT                                        DEFAULT 1                   NOT NULL COMMENT '활성화 여부 (1:활성, 0:비활성)',
    created_at      DATETIME                                       DEFAULT NULL                COMMENT '등록일시',
    updated_at      DATETIME                                       DEFAULT NULL                COMMENT '수정일시',
    created_user_id BIGINT                                         DEFAULT NULL                COMMENT '생성자 ID',
    updated_user_id BIGINT                                         DEFAULT NULL                COMMENT '수정자 ID',
    
    FOREIGN KEY (advertiser_id) REFERENCES ad_advertisers(id),
    INDEX idx_advertiser_created (advertiser_id, created_at),
    INDEX idx_transaction_type (transaction_type),
    INDEX idx_reference (reference_type, reference_id)
) ENGINE=InnoDB COMMENT='광고주 잔액 변경 이력';
```

---

## ⚙️ 운영 관리 테이블

### 7. 일일 예산 추적 (ad_daily_budget_trackings)
> **목적**: 캠페인별 일일 예산 소진 추적
> **비즈니스 요구사항**: 예산 초과 방지, 일일 성과 모니터링

**📋 데이터 Flow:**
- **INSERT**: 
  - 캠페인 활성화 시 당일 추적 레코드 자동 생성
  - daily_budget은 캠페인 설정값으로 초기화
- **UPDATE**: 
  - 클릭 발생 시 spent_amount 실시간 누적 (Worker 처리)
  - 노출/클릭/전환 카운트 실시간 증가 (Flink 집계)
  - spent_amount ≥ daily_budget 시 캠페인 자동 PAUSED
- **DELETE**: 삭제 없음, 일별 성과 분석용 영구 보관

```sql
CREATE TABLE ad_daily_budget_trackings (
    id              BIGINT                                         PRIMARY KEY AUTO_INCREMENT COMMENT '예산 추적 고유 식별자',
    campaign_id     BIGINT                                         NOT NULL                    COMMENT '캠페인 식별자 (FK)',
    track_date      DATE                                           NOT NULL                    COMMENT '추적 일자',
    daily_budget    DECIMAL(15,2)                                  NOT NULL                    COMMENT '설정된 일일 예산 (원)',
    spent_amount    DECIMAL(15,2)                                  NOT NULL DEFAULT 0.00       COMMENT '당일 사용 금액 (원)',
    impression_count BIGINT                                        NOT NULL DEFAULT 0          COMMENT '당일 노출 수',
    click_count     BIGINT                                         NOT NULL DEFAULT 0          COMMENT '당일 클릭 수',
    conversion_count BIGINT                                        NOT NULL DEFAULT 0          COMMENT '당일 전환 수',
    activated       TINYINT                                        DEFAULT 1 NOT NULL          COMMENT '활성화 여부',
    created_at      DATETIME                                       DEFAULT NULL                COMMENT '등록일시',
    updated_at      DATETIME                                       DEFAULT NULL                COMMENT '수정일시',
    created_user_id BIGINT                                         DEFAULT NULL                COMMENT '생성자',
    updated_user_id BIGINT                                         DEFAULT NULL                COMMENT '수정자',
    
    FOREIGN KEY (campaign_id) REFERENCES ad_campaigns(id),
    UNIQUE KEY uk_campaign_date (campaign_id, track_date),
    INDEX idx_track_date (track_date),
    INDEX idx_spent_budget (spent_amount, daily_budget)
) ENGINE=InnoDB COMMENT='캠페인별 일일 예산 사용량 추적';
```

### 8. 상품 상태 캐시 (ad_product_status_caches)
> **목적**: RTB 알고리즘용 상품 성과 지표 실시간 캐시
> **비즈니스 요구사항**: ω1/ω2 임계값 체크, 방어로직 트리거

**📋 데이터 Flow:**
- **INSERT**: 
  - 상품이 처음 광고에 등록될 때 기본값으로 생성
  - 모든 점수 0.0000, 카운트 0으로 초기화
- **UPDATE**: 
  - **실시간 업데이트**: Flink가 5분마다 성과 지표 재계산
  - **임계값 체크**: impression_count_1h ≥ ω1, click_count_1h ≥ ω2 확인
  - **TTL 관리**: 24시간 지난 카운트 자동 차감
  - **방어로직**: 임계값 미달 시 category_defense_stats 참조
- **DELETE**: 삭제 없음, 상품 비활성화 시에도 캐시 유지

```sql
CREATE TABLE ad_product_status_caches (
    product_id       BIGINT                                         PRIMARY KEY                 COMMENT '상품 식별자 (FK)',
    ctr_score        DECIMAL(6,4)                                   DEFAULT 0.0000              COMMENT '클릭률 점수 (0.0000~1.0000)',
    cvr_score        DECIMAL(6,4)                                   DEFAULT 0.0000              COMMENT '전환율 점수 (0.0000~1.0000)',
    popularity_score DECIMAL(6,4)                                   DEFAULT 0.0000              COMMENT '인기도 점수 (0.0000~1.0000)',
    last_impression  TIMESTAMP                                                                  COMMENT '최종 노출 시간',
    last_click       TIMESTAMP                                                                  COMMENT '최종 클릭 시간',
    last_conversion  TIMESTAMP                                                                  COMMENT '최종 전환 시간',
    impression_count_1h  BIGINT                                     DEFAULT 0                   COMMENT '1시간 노출 수 (ω1 임계값 체크용)',
    click_count_1h   BIGINT                                         DEFAULT 0                   COMMENT '1시간 클릭 수 (ω2 임계값 체크용)',
    impression_count_24h BIGINT                                     DEFAULT 0                   COMMENT '24시간 노출 수',
    click_count_24h  BIGINT                                         DEFAULT 0                   COMMENT '24시간 클릭 수',
    conversion_count_24h BIGINT                                     DEFAULT 0                   COMMENT '24시간 전환 수',
    last_threshold_check TIMESTAMP                                                              COMMENT '마지막 임계값 체크 시간',
    activated       TINYINT                                        DEFAULT 1 NOT NULL          COMMENT '활성화 여부',
    created_at      DATETIME                                       DEFAULT NULL                COMMENT '등록일시',
    updated_at      DATETIME                                       DEFAULT NULL                COMMENT '수정일시',
    created_user_id BIGINT                                         DEFAULT NULL                COMMENT '생성자',
    updated_user_id BIGINT                                         DEFAULT NULL                COMMENT '수정자',
    
    FOREIGN KEY (product_id) REFERENCES products(id),
    INDEX idx_ctr_score (ctr_score DESC),
    INDEX idx_cvr_score (cvr_score DESC),
    INDEX idx_popularity_score (popularity_score DESC),
    INDEX idx_threshold_check (last_threshold_check),
    INDEX idx_cache_updated (updated_at)
) ENGINE=InnoDB COMMENT='상품 성과 지표 캐시';
```

### 9. 노출별 가격 매핑 (ad_impression_pricings)
> **목적**: 클릭 시 차감할 정확한 가격 정보 저장
> **비즈니스 요구사항**: 24시간 클릭 추적, 정확한 과금, 실험 데이터 보존

**📋 데이터 Flow:**
- **INSERT**: 
  - RTB API 호출 시 노출 결과와 함께 생성 (impression_id 기준)
  - algorithm_score, calculated_price 등 과금 정보 저장
  - expires_at = impression_time + 24시간으로 설정
- **UPDATE**: 수정 불가, 과금의 정확성을 위해 Immutable
- **DELETE**: 
  - **자동 삭제**: expires_at < NOW() 인 레코드 시간별 정리
  - **수동 삭제**: 24시간 후 배치 작업으로 일괄 정리

```sql
CREATE TABLE ad_impression_pricings (
    impression_id    VARCHAR(50)                                    PRIMARY KEY                 COMMENT '노출 고유 식별자 (UUID)',
    device_id        VARCHAR(100)                                   NOT NULL                    COMMENT '디바이스 식별자',
    session_id       VARCHAR(100)                                   NOT NULL                    COMMENT '세션 식별자',
    campaign_id      BIGINT                                         NOT NULL                    COMMENT '캠페인 식별자 (FK)',
    product_id       BIGINT                                         NOT NULL                    COMMENT '상품 식별자 (FK)',
    placement        VARCHAR(20)                                    NOT NULL                    COMMENT '광고 영역',
    bid_price        DECIMAL(10,2)                                  NOT NULL                    COMMENT '입찰가 (원)',
    calculated_price DECIMAL(10,2)                                  NOT NULL                    COMMENT '산정된 적용가 (원) - 클릭 시 차감될 금액',
    ad_rank          INT                                            NOT NULL                    COMMENT '광고 순위 (1등, 2등, 3등...)',
    algorithm_score  DECIMAL(10,4)                                  NOT NULL                    COMMENT '알고리즘 점수 S_α(a,i)',
    experiment_key   VARCHAR(50)                                                                COMMENT '실험 키',
    experiment_var   VARCHAR(50)                                                                COMMENT '실험 변수',
    impression_time  TIMESTAMP(3)                                   NOT NULL                    COMMENT '노출 시간 (밀리초 포함)',
    expires_at       TIMESTAMP                                      NOT NULL                    COMMENT '만료 시간 (24시간 후)',
    activated       TINYINT                                        DEFAULT 1 NOT NULL          COMMENT '활성화 여부',
    created_at      DATETIME                                       DEFAULT NULL                COMMENT '등록일시',
    updated_at      DATETIME                                       DEFAULT NULL                COMMENT '수정일시',
    created_user_id BIGINT                                         DEFAULT NULL                COMMENT '생성자',
    updated_user_id BIGINT                                         DEFAULT NULL                COMMENT '수정자',

    FOREIGN KEY (campaign_id) REFERENCES ad_campaigns(id),
    FOREIGN KEY (product_id) REFERENCES ad_products_meta(product_id),
    INDEX idx_device_session (device_id, session_id),
    INDEX idx_product_placement (product_id, placement),
    INDEX idx_expires_at (expires_at),
    INDEX idx_impression_time (impression_time)
) ENGINE=InnoDB COMMENT='노출별 가격 매핑';
```

---

## 📊 성과 분석 테이블

### 10. 실시간 성과 메트릭 (ad_performance_metrics_realtime)
> **목적**: 시간별 캠페인/상품 성과 지표 집계
> **비즈니스 요구사항**: 실시간 대시보드, ROAS/CTR/CVR 모니터링

**📋 데이터 Flow:**
- **INSERT**: 
  - Flink Statement가 5분 윈도우로 초기 메트릭 생성
  - metric_hour 단위로 절삭하여 시간별 집계
- **UPDATE**: 
  - **실시간 누적**: 노출/클릭/전환 발생 시 해당 시간 메트릭 업데이트
  - **지표 재계산**: CTR = click_count/impression_count, CVR = conversion_count/click_count
  - **ROAS 계산**: total_revenue/total_spend (0으로 나누기 방지)
- **DELETE**: 
  - **TTL 삭제**: 7일 지난 메트릭 자동 삭제 (파티셔닝 정리)
  - **성과 분석**: 삭제 전 ad_event_summaries_daily로 요약 이관

```sql
CREATE TABLE ad_performance_metrics_realtime (
    id               BIGINT                                         PRIMARY KEY AUTO_INCREMENT COMMENT '실시간 메트릭 고유 식별자',
    campaign_id      BIGINT                                         NOT NULL                    COMMENT '캠페인 식별자 (FK)',
    product_id       BIGINT                                         NOT NULL                    COMMENT '상품 식별자 (FK)',
    placement        VARCHAR(20)                                    NOT NULL                    COMMENT '광고 영역',
    metric_hour      TIMESTAMP                                      NOT NULL                    COMMENT '시간별 메트릭 (시간 단위로 절삭)',
    impression_count BIGINT                                         DEFAULT 0                   COMMENT '노출 수',
    click_count      BIGINT                                         DEFAULT 0                   COMMENT '클릭 수',
    conversion_count BIGINT                                         DEFAULT 0                   COMMENT '전환 수',
    total_spend      DECIMAL(15,2)                                  DEFAULT 0.00                COMMENT '총 소진 금액 (원)',
    total_revenue    DECIMAL(15,2)                                  DEFAULT 0.00                COMMENT '총 기여 매출 (원)',
    avg_cpc          DECIMAL(10,2)                                  DEFAULT 0.00                COMMENT '평균 클릭당 비용 (원)',
    ctr              DECIMAL(6,4)                                   DEFAULT 0.0000              COMMENT '클릭률 (Click Through Rate)',
    cvr              DECIMAL(6,4)                                   DEFAULT 0.0000              COMMENT '전환율 (Conversion Rate)',
    roas             DECIMAL(8,2)                                   DEFAULT 0.00                COMMENT '광고 수익률 (Return on Ad Spend)',
    activated       TINYINT                                        DEFAULT 1 NOT NULL          COMMENT '활성화 여부',
    created_at      DATETIME                                       DEFAULT NULL                COMMENT '등록일시',
    updated_at      DATETIME                                       DEFAULT NULL                COMMENT '수정일시',
    created_user_id BIGINT                                         DEFAULT NULL                COMMENT '생성자',
    updated_user_id BIGINT                                         DEFAULT NULL                COMMENT '수정자',
    
    FOREIGN KEY (campaign_id) REFERENCES ad_campaigns(id),
    FOREIGN KEY (product_id) REFERENCES ad_products_meta(product_id),
    UNIQUE KEY uk_campaign_product_placement_hour (campaign_id, product_id, placement, metric_hour),
    INDEX idx_metric_hour (metric_hour),
    INDEX idx_placement_hour (placement, metric_hour),
    INDEX idx_roas (roas DESC),
    INDEX idx_last_updated (updated_at)
) ENGINE=InnoDB COMMENT='실시간 성과 메트릭';
```

### 11. 이벤트 요약 (ad_event_summaries_daily)
> **목적**: 일별 성과 요약 및 장기 보관
> **비즈니스 요구사항**: CSV 리포트, 월별 정산, 트렌드 분석

**📋 데이터 Flow:**
- **INSERT**: 
  - 매일 새벽 배치 작업으로 전일 성과 요약 생성
  - ad_performance_metrics_realtime 데이터 집계하여 일별 요약
  - S3 원시 데이터 경로(s3_path) 연결
- **UPDATE**: 
  - **재집계**: 데이터 오류 발견 시 해당 일자 재계산
  - **S3 연동**: 새로운 원시 데이터 적재 시 s3_path 업데이트
- **DELETE**: 
  - **장기 보관**: 13개월 후 아카이브 스토리지로 이관
  - **월별 파티셔닝**: 자동 파티션 삭제로 성능 관리

```sql
CREATE TABLE ad_event_summaries_daily (
    id               BIGINT                                         PRIMARY KEY AUTO_INCREMENT COMMENT '일별 요약 고유 식별자',
    summary_date     DATE                                           NOT NULL                    COMMENT '요약 날짜',
    campaign_id      BIGINT                                         NOT NULL                    COMMENT '캠페인 식별자 (FK)',
    product_id       BIGINT                                         NOT NULL                    COMMENT '상품 식별자 (FK)',
    placement        VARCHAR(20)                                    NOT NULL                    COMMENT '광고 영역',
    impression_count BIGINT                                         DEFAULT 0                   COMMENT '노출 수',
    click_count      BIGINT                                         DEFAULT 0                   COMMENT '클릭 수',
    conversion_count BIGINT                                         DEFAULT 0                   COMMENT '전환 수',
    total_spend      DECIMAL(15,2)                                  DEFAULT 0.00                COMMENT '총 소진 금액 (원)',
    total_revenue    DECIMAL(15,2)                                  DEFAULT 0.00                COMMENT '총 기여 매출 (원)',
    unique_users     BIGINT                                         DEFAULT 0                   COMMENT '순 사용자 수',
    s3_path          VARCHAR(500)                                                               COMMENT '해당 날짜 S3 원시 데이터 경로',
    activated       TINYINT                                        DEFAULT 1 NOT NULL          COMMENT '활성화 여부',
    created_at      DATETIME                                       DEFAULT NULL                COMMENT '등록일시',
    updated_at      DATETIME                                       DEFAULT NULL                COMMENT '수정일시',
    created_user_id BIGINT                                         DEFAULT NULL                COMMENT '생성자',
    updated_user_id BIGINT                                         DEFAULT NULL                COMMENT '수정자',
    
    FOREIGN KEY (campaign_id) REFERENCES ad_campaigns(id),
    UNIQUE KEY uk_daily_summary (summary_date, campaign_id, product_id, placement),
    INDEX idx_summary_date (summary_date),
    INDEX idx_campaign_date (campaign_id, summary_date),
    INDEX idx_placement_date (placement, summary_date)
) ENGINE=InnoDB COMMENT='일별 이벤트 요약';
```

---

## 🔧 시스템 설정 테이블

### 12. 카테고리별 방어값 통계 (ad_category_defense_stats)
> **목적**: RTB 방어로직용 카테고리별 기준값 제공
> **비즈니스 요구사항**: 데이터 부족 시 CTR/CVR 대체값, δ 파라미터 적용

**📋 데이터 Flow:**
- **INSERT**: 
  - 새 카테고리 생성 시 기본 통계값(0.0000)으로 생성
  - 상위 카테고리 통계를 상속받아 초기값 설정
- **UPDATE**: 
  - **정기 업데이트**: 12시간마다 전체 카테고리 통계 재계산
  - **점진적 업데이트**: 성과 데이터 누적 시 점진적 평균 업데이트
  - **기간별 계산**: calculation_period(7DAYS/30DAYS/90DAYS) 설정에 따라 재계산
- **DELETE**: 삭제 없음, 카테고리 비활성화 시에도 통계 보존

```sql
CREATE TABLE ad_category_defense_stats (
    id               BIGINT                                         PRIMARY KEY AUTO_INCREMENT COMMENT '통계 고유 식별자',
    category_path    VARCHAR(400)                                   UNIQUE NOT NULL             COMMENT '카테고리 경로 (1차>2차>3차>4차)',
    category_level   TINYINT                                        NOT NULL                    COMMENT '카테고리 레벨 (1/2/3/4)',
    avg_ctr          DECIMAL(6,4)                                   DEFAULT 0.0000              COMMENT '카테고리 평균 CTR (방어값 계산용)',
    min_ctr          DECIMAL(6,4)                                   DEFAULT 0.0000              COMMENT '카테고리 최소 CTR (방어값 계산용)',
    avg_cvr          DECIMAL(6,4)                                   DEFAULT 0.0000              COMMENT '카테고리 평균 CVR (방어값 계산용)',
    min_cvr          DECIMAL(6,4)                                   DEFAULT 0.0000              COMMENT '카테고리 최소 CVR (방어값 계산용)',
    sample_count     BIGINT                                         DEFAULT 0                   COMMENT '통계 계산용 샘플 데이터 개수',
    calculation_period VARCHAR(20)                                  DEFAULT '30DAYS'            COMMENT '통계 계산 기간 (7DAYS/30DAYS/90DAYS)',
    last_calculated  TIMESTAMP                                                                  COMMENT '마지막 통계 계산 시간',
    activated       TINYINT                                        DEFAULT 1 NOT NULL          COMMENT '활성화 여부',
    created_at      DATETIME                                       DEFAULT NULL                COMMENT '등록일시',
    updated_at      DATETIME                                       DEFAULT NULL                COMMENT '수정일시',
    created_user_id BIGINT                                         DEFAULT NULL                COMMENT '생성자',
    updated_user_id BIGINT                                         DEFAULT NULL                COMMENT '수정자',
    
    INDEX idx_category_level (category_level),
    INDEX idx_path_level (category_path, category_level),
    INDEX idx_last_calculated (last_calculated),
    CHECK (category_level BETWEEN 1 AND 4),
    CHECK (avg_ctr >= 0.0000 AND avg_ctr <= 1.0000),
    CHECK (min_ctr >= 0.0000 AND min_ctr <= 1.0000),
    CHECK (avg_cvr >= 0.0000 AND avg_cvr <= 1.0000),
    CHECK (min_cvr >= 0.0000 AND min_cvr <= 1.0000)
) ENGINE=InnoDB COMMENT='카테고리별 방어값 통계 - RTB 알고리즘 데이터 부족 시 대체값 제공';
```

### 13. 카테고리 계층 (ad_category_hierarchies)
> **목적**: 4단계 상품 카테고리 계층 구조 관리
> **비즈니스 요구사항**: 카테고리별 타겟팅, 방어로직 계층 적용

**📋 데이터 Flow:**
- **INSERT**: 
  - 상품 카테고리 신규 생성 시 계층 구조에 맞게 생성
  - parent_id 연결 및 category_path 자동 생성
- **UPDATE**: 
  - **계층 변경**: parent_id 변경 시 하위 계층 category_path 일괄 업데이트
  - **표시 순서**: display_order 변경으로 카테고리 정렬 순서 조정
  - **활성화 관리**: 상위 카테고리 비활성화 시 하위도 연쇄 비활성화
- **DELETE**: 논리적 삭제, 하위 카테고리 존재 시 삭제 제한

```sql
CREATE TABLE ad_category_hierarchies (
    id              BIGINT                                         PRIMARY KEY AUTO_INCREMENT COMMENT '카테고리 고유 식별자',
    category_name   VARCHAR(100)                                   NOT NULL                    COMMENT '카테고리명',
    category_level  TINYINT                                        NOT NULL                    COMMENT '카테고리 레벨 (1/2/3/4)',
    parent_id       BIGINT                                                                     COMMENT '상위 카테고리 ID (1차는 NULL)',
    category_path   VARCHAR(400)                                                               COMMENT '카테고리 전체 경로 (1차>2차>3차>4차)',
    display_order   INT                                            DEFAULT 0                   COMMENT '표시 순서',
    activated       TINYINT                                        DEFAULT 1 NOT NULL          COMMENT '활성화 여부',
    created_at      DATETIME                                       DEFAULT NULL                COMMENT '등록일시',
    updated_at      DATETIME                                       DEFAULT NULL                COMMENT '수정일시',
    created_user_id BIGINT                                         DEFAULT NULL                COMMENT '생성자',
    updated_user_id BIGINT                                         DEFAULT NULL                COMMENT '수정자',
    
    FOREIGN KEY (parent_id) REFERENCES ad_category_hierarchies(id),
    INDEX idx_level_parent (category_level, parent_id),
    INDEX idx_path (category_path),
    INDEX idx_active_order (display_order),
    CHECK (category_level BETWEEN 1 AND 4)
) ENGINE=InnoDB COMMENT='상품 카테고리 계층 구조 - 4단계 분류 체계';
```

### 14. 엔진 파라미터 (ad_engine_parameters)
> **목적**: RTB 알고리즘 파라미터 중앙 관리
> **비즈니스 요구사항**: α/π/ω1/ω2/δ 파라미터 런타임 변경 지원

**📋 데이터 Flow:**
- **INSERT**: 
  - 시스템 초기화 시 기본 파라미터(α=0.1, π=24시간 등) 생성
  - 영역별 파라미터 필요 시 placement 지정하여 생성
- **UPDATE**: 
  - **파라미터 조정**: 성과 최적화를 위한 파라미터 값 변경
  - **적용 기간**: effective_from/until 설정으로 시간별 파라미터 제어
  - **변경 이력**: 모든 변경사항 ad_engine_parameter_histories에 자동 기록
- **DELETE**: 삭제 불가, effective_until 설정으로 비활성화

```sql
CREATE TABLE ad_engine_parameters (
    id              BIGINT                                         PRIMARY KEY AUTO_INCREMENT COMMENT '파라미터 고유 식별자',
    parameter_name  VARCHAR(100)                                   UNIQUE NOT NULL             COMMENT '파라미터명 (alpha/pi/omega1/omega2/delta)',
    parameter_value DECIMAL(10,4)                                  NOT NULL                    COMMENT '파라미터 값',
    description     TEXT                                                                       COMMENT '파라미터 설명',
    placement       VARCHAR(20)                                                                COMMENT '적용 영역 (NULL=전체 적용)',
    effective_from  TIMESTAMP                                      DEFAULT CURRENT_TIMESTAMP  COMMENT '적용 시작 시간',
    effective_until TIMESTAMP                                                                  COMMENT '적용 종료 시간 (NULL=무제한)',
    created_by      VARCHAR(100)                                   NOT NULL                    COMMENT '기존 생성자 (비즈니스 로직용)',
    activated       TINYINT                                        DEFAULT 1 NOT NULL          COMMENT '활성화 여부',
    created_at      DATETIME                                       DEFAULT NULL                COMMENT '등록일시',
    updated_at      DATETIME                                       DEFAULT NULL                COMMENT '수정일시',
    created_user_id BIGINT                                         DEFAULT NULL                COMMENT '생성자',
    updated_user_id BIGINT                                         DEFAULT NULL                COMMENT '수정자',
    
    INDEX idx_name_active (parameter_name),
    INDEX idx_placement (placement),
    INDEX idx_effective_period (effective_from, effective_until)
) ENGINE=InnoDB COMMENT='광고 엔진 파라미터 관리 - 알고리즘 설정값 중앙 관리';
```

### 15. 엔진 파라미터 변경 이력 (ad_engine_parameter_histories)
> **목적**: 파라미터 변경 이력 추적 및 롤백 지원
> **비즈니스 요구사항**: 성과 변화 원인 분석, 파라미터 롤백

**📋 데이터 Flow:**
- **INSERT**: 
  - ad_engine_parameters 변경 시 자동으로 이력 생성
  - old_value/new_value, 변경 사유(change_reason) 기록
- **UPDATE**: 이력 데이터는 수정 불가 (Audit 목적)
- **DELETE**: 삭제 불가, 파라미터 변경 추적을 위한 영구 보관

```sql
CREATE TABLE ad_engine_parameter_histories (
    id               BIGINT                                         PRIMARY KEY AUTO_INCREMENT COMMENT '파라미터 변경 이력 고유 식별자',
    parameter_id     BIGINT                                         NOT NULL                    COMMENT '파라미터 식별자 (FK)',
    old_value        DECIMAL(10,4)                                                              COMMENT '변경 전 값',
    new_value        DECIMAL(10,4)                                  NOT NULL                    COMMENT '변경 후 값',
    change_reason    TEXT                                                                       COMMENT '변경 사유',
    changed_by       VARCHAR(100)                                   NOT NULL                    COMMENT '변경자',
    effective_from   TIMESTAMP                                      DEFAULT CURRENT_TIMESTAMP  COMMENT '적용 시작 시간',
    
    -- 공통 필드 (이력 테이블이므로 activated, updated_at 제외)
    created_at       DATETIME                                       DEFAULT NULL                COMMENT '등록일시',
    created_user_id  BIGINT                                         DEFAULT NULL                COMMENT '생성자 ID',
    
    FOREIGN KEY (parameter_id) REFERENCES ad_engine_parameters(id),
    INDEX idx_parameter_created (parameter_id, created_at),
    INDEX idx_changed_by (changed_by),
    INDEX idx_effective_from (effective_from)
) ENGINE=InnoDB COMMENT='엔진 파라미터 변경 이력 - 파라미터 조정 추적 및 롤백 지원';
```

---

## 📊 데이터 처리 전략

### **실시간 vs 배치 처리 구분**

| 처리 방식 | 데이터 저장소 | 목적 | 보관 기간 |
|-----------|---------------|------|-----------|
| **실시간 처리** | MariaDB | 비즈니스 로직, 잔액 차감, 실시간 지표 | 3-7일 |
| **배치 처리** | S3 (Parquet) | 상세 분석, 리포트, 장기 보관 | 2년+ |

### **S3 이벤트 저장 구조**
```
s3://cpc-ad-events/
├── year=2024/
│   ├── month=01/
│   │   ├── day=15/
│   │   │   ├── hour=14/
│   │   │   │   ├── impression_events.parquet
│   │   │   │   ├── click_events.parquet
│   │   │   │   └── conversion_events.parquet
│   │   │   └── hour=15/
│   │   └── day=16/
│   └── month=02/
└── processed/
    ├── daily_reports/
    └── monthly_aggregates/
```

### **이벤트 처리 흐름**
```
실시간: Kafka → Flink → {Redis 지표, DB 집계}
배치:   Kafka → S3 → Athena/Spark → {리포트, 분석}
```

---

## ⚡ 파티셔닝 및 성능 최적화

### 1. 대용량 테이블 파티셔닝

**대용량 테이블별 파티셔닝 전략**

| 테이블 | 파티셔닝 방식 | 보관 기간 | 자동 정리 |
|--------|---------------|-----------|-----------|
| `ad_event_summaries_daily` | 월별 | 13개월 | 스케줄러 |
| `ad_performance_metrics_realtime` | 일별 | 7일 | TTL |
| `ad_impression_pricings` | 일별 | 24시간 | TTL |
| `ad_balance_histories` | 월별 | 2년 | 보관 |

```sql
-- 1. 실시간 메트릭 (일별 파티셔닝 + TTL)
ALTER TABLE ad_performance_metrics_realtime 
PARTITION BY RANGE (TO_DAYS(metric_hour)) (
    PARTITION p_today VALUES LESS THAN (TO_DAYS(CURDATE() + INTERVAL 1 DAY)),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);

-- 2. 노출 가격 매핑 (자동 만료)
CREATE EVENT cleanup_expired_impressions
ON SCHEDULE EVERY 1 HOUR
DO DELETE FROM ad_impression_pricings WHERE expires_at < NOW();

-- 3. 일별 요약 (월별 파티셔닝)
ALTER TABLE ad_event_summaries_daily 
PARTITION BY RANGE (YEAR(summary_date) * 100 + MONTH(summary_date)) (
    PARTITION p202401 VALUES LESS THAN (202402),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

### 2. 핵심 인덱스 전략

**성능 중요도별 인덱스 구성**

| 우선순위 | 인덱스 용도 | 테이블 | 예상 QPS |
|----------|-------------|--------|----------|
| **P0** | RTB 입찰가 조회 | `ad_placement_bids` | 1000+ |
| **P0** | 잔액 실시간 체크 | `ad_balances` | 1000+ |
| **P0** | 클릭 가격 매핑 | `ad_impression_pricings` | 500+ |
| **P1** | 방어값 통계 조회 | `ad_category_defense_stats` | 100+ |
| **P1** | 성과 지표 조회 | `ad_performance_metrics_realtime` | 50+ |

```sql
-- P0: RTB 알고리즘 핵심 인덱스
CREATE INDEX idx_rtb_lookup ON ad_placement_bids 
(placement, status, product_id) INCLUDE (bid_price, max_daily_spend);

CREATE INDEX idx_balance_check ON ad_balances (advertiser_id) 
INCLUDE (current_balance, daily_spent, alert_threshold);

CREATE INDEX idx_pricing_lookup ON ad_impression_pricings 
(device_id, product_id, placement, impression_time DESC);

-- P1: 보조 성능 인덱스
CREATE INDEX idx_defense_stats ON ad_category_defense_stats 
(category_path, category_level) INCLUDE (avg_ctr, min_ctr, avg_cvr, min_cvr);

CREATE INDEX idx_metrics_hour ON ad_performance_metrics_realtime 
(campaign_id, placement, metric_hour DESC);

-- P2: 관리/분석용 인덱스
CREATE INDEX idx_parameter_active ON ad_engine_parameters 
(parameter_name, effective_from, effective_until);
```

---

## 📋 테이블 관계 요약

### **핵심 관계도**
```
ad_advertisers (1) ←→ (N) ad_campaigns
ad_campaigns (1) ←→ (N) ad_placement_bids
ad_placement_bids (N) ←→ (1) ad_products_meta
ad_advertisers (1) ←→ (1) ad_balances
```

### **데이터 흐름**
1. **광고 요청** → `ad_placement_bids`, `ad_products_meta` 조회
2. **클릭 발생** → `ad_impression_pricings`에서 가격 확인 → `ad_balances` 차감
3. **성과 집계** → `ad_performance_metrics_realtime` 업데이트
4. **일별 정산** → `ad_event_summaries_daily` 생성

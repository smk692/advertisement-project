# CPC RTB ì‹œìŠ¤í…œ Kafka í† í”½ ì„¤ê³„ (ìµœì í™”)

## ğŸ“‹ ëª©ì°¨
1. [ì•„í‚¤í…ì²˜ ê¸°ë°˜ í† í”½ ë¶„ì„](#-ì•„í‚¤í…ì²˜-ê¸°ë°˜-í† í”½-ë¶„ì„)
2. [í•µì‹¬ í† í”½ ì„¤ê³„ (3ê°œ)](#-í•µì‹¬-í† í”½-ì„¤ê³„-3ê°œ)
3. [í† í”½ë³„ ì—­í•  ë¶„ë‹´](#-í† í”½ë³„-ì—­í• -ë¶„ë‹´)
4. [ìµœì í™”ëœ ë°ì´í„° í”Œë¡œìš°](#-ìµœì í™”ëœ-ë°ì´í„°-í”Œë¡œìš°)

---

## ğŸ“‹ ì•„í‚¤í…ì²˜ ê¸°ë°˜ í† í”½ ë¶„ì„

### ğŸ¯ í•µì‹¬ ë°ì´í„° í”Œë¡œìš° ë¶„ì„ (ìµœì í™”ëœ ì—­í•  ë¶„ë‹´)

ì—…ë°ì´íŠ¸ëœ ì•„í‚¤í…ì²˜ë¥¼ ë°”íƒ•ìœ¼ë¡œ **ì—­í•  ë¶„ë‹´ ìµœì í™”**:

#### **1. Flink (ë³µì¡í•œ ì‘ì—…) - 4ê°œ Statement**
```
campaign-events â†’ Flink RTB Statement â†’ Redis ìˆœìœ„ ìºì‹œ
ad-events â†’ Flink ì„±ê³¼ Statement â†’ Redis ì§€í‘œ ìºì‹œ  
conversion-events + ad-events â†’ Flink ì „í™˜ Statement â†’ DB ì „í™˜ ê²°ê³¼
ad-events â†’ Flink ì¤‘ë³µ íƒì§€ Statement â†’ compensation-events â­ ì‹ ê·œ
```

#### **2. Worker (ê°„ë‹¨í•œ ì‘ì—…) - 3ê°œ ì‹¤ì‹œê°„ ì²˜ë¦¬**
```
ad-events (CLICK) â†’ Worker ì”ì•¡ ì°¨ê° â†’ DB ì¦‰ì‹œ INSERT
ad-events â†’ Worker ì˜ˆì‚° ëª¨ë‹ˆí„°ë§ â†’ Redis/DB ì‹¤ì‹œê°„ ì²´í¬
compensation-events â†’ Worker ë³´ìƒ ì²˜ë¦¬ â†’ DB ì”ì•¡ ë³µêµ¬ â­ ì‹ ê·œ
```

#### **3. í•µì‹¬ ì„¤ê³„ ì›ì¹™**
- **ì¤‘ê°„ í† í”½ ì œê±°**: Flink â†’ ì¤‘ê°„í† í”½ â†’ Worker ëŒ€ì‹  **ì§ì ‘ ì²˜ë¦¬**
- **ì´ì¤‘ ì†Œë¹„**: ad-eventsë¥¼ Flinkì™€ Workerê°€ ê°ê° ë‹¤ë¥¸ ëª©ì ìœ¼ë¡œ ì†Œë¹„
- **ì‹¤ì‹œê°„ì„± ê·¹ëŒ€í™”**: Workerê°€ ê°„ë‹¨í•œ ì‘ì—…ì„ ì¦‰ì‹œ ì²˜ë¦¬

---

## ğŸ¯ í•µì‹¬ í† í”½ ì„¤ê³„ (4ê°œ)

### **1. `campaign-events` (P0 - ìº í˜ì¸ ë³€ê²½ ì´ë²¤íŠ¸)**

**ëª©ì **: ìº í˜ì¸ ë“±ë¡/ìˆ˜ì • ì‹œ RTB ìˆœìœ„ ì¬ê³„ì‚° íŠ¸ë¦¬ê±°

**ì´ë²¤íŠ¸ íƒ€ì…**: 
- `CAMPAIGN_CREATED`: ìƒˆ ìº í˜ì¸ ë“±ë¡
- `CAMPAIGN_UPDATED`: ìº í˜ì¸ ì •ë³´ ìˆ˜ì • (ì…ì°°ê°€, ì˜ˆì‚°, íƒ€ê²ŸíŒ… ë“±)
- `CAMPAIGN_APPROVED`: ìº í˜ì¸ ìŠ¹ì¸ (RTB ê²½ìŸ ì°¸ì—¬ ì‹œì‘)
- `CAMPAIGN_STATUS_CHANGED`: ìº í˜ì¸ ì¼ì‹œì •ì§€/ì¬ê°œ/ì‚­ì œ

**ìŠ¤í‚¤ë§ˆ**:
```json
{
  "event_type": "CAMPAIGN_CREATED|CAMPAIGN_UPDATED|CAMPAIGN_APPROVED|CAMPAIGN_STATUS_CHANGED",
  "timestamp": "2024-01-15T10:30:00Z",
  "campaign_id": "campaign_100",
  "advertiser_id": "advertiser_50",
  "product_id": "product_200",
  "placement": "HOME|CATEGORY|PRODUCT_DETAIL|SEARCH",
  "category": "ì „ìì œí’ˆ/ì»´í“¨í„°",
  "bid_price": 1500,
  "daily_budget": 100000,
  "status": "PENDING|ACTIVE|PAUSED|DELETED",
  "approval_status": "PENDING|APPROVED|REJECTED",
  "targeting": {
    "device_types": ["MOBILE", "DESKTOP"],
    "age_groups": ["20-29", "30-39"]
  },
  "effective_from": "2024-01-15T11:00:00Z",
  "rtb_impact": "HIGH|MEDIUM|LOW"
}
```

**íŒŒí‹°ì…”ë‹**: `placement` + `category` ê¸°ì¤€ (RTB ìºì‹œ í‚¤ ì¼ì¹˜)

**ì†Œë¹„ì**:
- **Flink RTB Statement**: ë³µì¡í•œ JOIN + RTB ì•Œê³ ë¦¬ì¦˜ ê³„ì‚° â†’ Redis ìˆœìœ„ ìºì‹œ ì—…ë°ì´íŠ¸

**ğŸ¯ ìº í˜ì¸ ìŠ¹ì¸ì˜ RTB ì„íŒ©íŠ¸**:
- **CAMPAIGN_APPROVED**: ìƒˆ ê²½ìŸì ë“±ì¥ìœ¼ë¡œ ì „ì²´ ìˆœìœ„ ì¬ê³„ì‚° í•„ìš”
- **rtb_impact = HIGH**: ì¸ê¸° ì¹´í…Œê³ ë¦¬ ê³ ì•¡ ì…ì°° â†’ ì „ì²´ ìˆœìœ„ ë³€ë™
- **rtb_impact = MEDIUM**: ì¼ë°˜ ì¹´í…Œê³ ë¦¬ ì¤‘ê°„ ì…ì°° â†’ ë¶€ë¶„ ìˆœìœ„ ë³€ë™  
- **rtb_impact = LOW**: í‹ˆìƒˆ ì¹´í…Œê³ ë¦¬ ì €ì•¡ ì…ì°° â†’ ìµœì†Œ ìˆœìœ„ ë³€ë™

---

### **2. `ad-events` (P0 - í†µí•© ê´‘ê³  ì´ë²¤íŠ¸)**

**ëª©ì **: ëª¨ë“  ê´‘ê³  ì´ë²¤íŠ¸ í†µí•© ì²˜ë¦¬ (Flink + Worker ì´ì¤‘ ì†Œë¹„)

**ì´ë²¤íŠ¸ íƒ€ì…**: 
- `IMPRESSION`: ê´‘ê³  ë…¸ì¶œ
- `CLICK`: ê´‘ê³  í´ë¦­  
- `CONVERSION`: êµ¬ë§¤ ì „í™˜

**ìŠ¤í‚¤ë§ˆ**:
```json
{
  "event_type": "IMPRESSION|CLICK|CONVERSION",
  "timestamp": "2024-01-15T10:30:00Z",
  "device_id": "device_12345",
  "session_id": "session_67890",
  "ad_id": "ad_001",
  "campaign_id": "campaign_100",
  "advertiser_id": "advertiser_50",
  "product_id": "product_200",
  "placement": "HOME|CATEGORY|PRODUCT_DETAIL|SEARCH",
  "bid_price": 1500,
  "actual_price": 1200,
  "search_term": "ë…¸íŠ¸ë¶",
  "category": "ì „ìì œí’ˆ/ì»´í“¨í„°",
  "revenue_amount": 50000,
  "order_id": "order_789"
}
```

**íŒŒí‹°ì…”ë‹**: `device_id` ê¸°ì¤€ (24ì‹œê°„ í´ë¦­-ì „í™˜ ë§¤ì¹­ ìµœì í™”)

**ì†Œë¹„ì**:
- **Flink ì„±ê³¼ Statement**: 5ë¶„ WINDOW + CTR/CVR ê³„ì‚° â†’ Redis ì§€í‘œ ìºì‹œ ì—…ë°ì´íŠ¸
- **Flink ì „í™˜ Statement**: 24ì‹œê°„ WINDOW + í´ë¦­-ì „í™˜ JOIN â†’ DB ì „í™˜ ê²°ê³¼ ì €ì¥
- **Flink ì¤‘ë³µ íƒì§€ Statement**: 5ë¶„ WINDOW + ì¤‘ë³µ í´ë¦­ íƒì§€ â†’ compensation-events ë°œí–‰ â­ ì‹ ê·œ
- **Worker ì”ì•¡ ì²˜ë¦¬**: CLICK ì´ë²¤íŠ¸ë§Œ í•„í„°ë§ â†’ ì¦‰ì‹œ ì”ì•¡ ì°¨ê° (ì¤‘ë³µ ì²´í¬ ì—†ìŒ)
- **Worker ì˜ˆì‚° ëª¨ë‹ˆí„°ë§**: ì‹¤ì‹œê°„ ì˜ˆì‚° ì²´í¬ â†’ ì„ê³„ê°’ ì•Œë¦¼/ìº í˜ì¸ ì¤‘ì§€

---

### **3. `conversion-events` (P1 - ì „í™˜ ì´ë²¤íŠ¸)**

**ëª©ì **: 24ì‹œê°„ í´ë¦­-ì „í™˜ ë§¤ì¹­ì„ ìœ„í•œ ì „í™˜ ë°ì´í„°

**ìŠ¤í‚¤ë§ˆ**:
```json
{
  "timestamp": "2024-01-15T14:30:00Z",
  "device_id": "device_12345",
  "session_id": "session_67890",
  "order_id": "order_789",
  "product_id": "product_200",
  "revenue_amount": 50000,
  "conversion_type": "PURCHASE|ADD_TO_CART|SIGNUP",
  "attribution_window": 24,
  "referrer_url": "https://example.com/product/200"
}
```

**íŒŒí‹°ì…”ë‹**: `device_id` ê¸°ì¤€ (ad-eventsì™€ ë™ì¼)

**ì†Œë¹„ì**:
- **Flink ì „í™˜ Statement**: ad-eventsì™€ JOINí•˜ì—¬ 24ì‹œê°„ ë‚´ í´ë¦­-ì „í™˜ ë§¤ì¹­

---

### **4. `compensation-events` (P1 - ì¤‘ë³µ í´ë¦­ ë³´ìƒ ì´ë²¤íŠ¸) â­ ì‹ ê·œ**

**ëª©ì **: ì¤‘ë³µ í´ë¦­ íƒì§€ í›„ ì”ì•¡ ë³´ìƒ ì²˜ë¦¬

**ìŠ¤í‚¤ë§ˆ**:
```json
{
  "timestamp": "2024-01-15T10:35:00Z",
  "advertiser_id": "advertiser_50",
  "campaign_id": "campaign_100",
  "ad_id": "ad_001",
  "device_id": "device_12345",
  "duplicate_click_count": 3,
  "refund_amount": 2400,
  "original_click_timestamps": [
    "2024-01-15T10:30:15Z",
    "2024-01-15T10:30:18Z", 
    "2024-01-15T10:30:22Z"
  ],
  "detection_window": "5_MINUTES",
  "reason": "DUPLICATE_CLICK_DETECTED",
  "compensation_type": "BALANCE_REFUND"
}
```

**íŒŒí‹°ì…”ë‹**: `advertiser_id` ê¸°ì¤€ (ì”ì•¡ ì²˜ë¦¬ ìµœì í™”)

**ì†Œë¹„ì**:
- **Worker ë³´ìƒ ì²˜ë¦¬**: ì¤‘ë³µ í´ë¦­ ë³´ìƒ ì´ë²¤íŠ¸ ìˆ˜ì‹  â†’ ì¦‰ì‹œ ì”ì•¡ ë³µêµ¬

---

## ğŸ”„ í† í”½ë³„ ì—­í•  ë¶„ë‹´

### **ğŸ“Š í† í”½ ì†Œë¹„ ë§¤í•‘**

| í† í”½ | Flink ì²˜ë¦¬ | Worker ì²˜ë¦¬ | ì§ì ‘ ì¶œë ¥ |
|------|------------|-------------|----------|
| `campaign-events` | âœ… RTB ì¬ê³„ì‚° Statement | - | Redis ìˆœìœ„ ìºì‹œ |
| `ad-events` | âœ… ì„±ê³¼ ì§‘ê³„ Statement<br/>âœ… ì „í™˜ ë§¤ì¹­ Statement<br/>âœ… ì¤‘ë³µ íƒì§€ Statement â­ | âœ… ì”ì•¡ ì°¨ê°<br/>âœ… ì˜ˆì‚° ëª¨ë‹ˆí„°ë§ | Redis ì§€í‘œ ìºì‹œ<br/>DB ì „í™˜ ê²°ê³¼<br/>DB ì”ì•¡ ì´ë ¥<br/>compensation-events ë°œí–‰ â­ |
| `conversion-events` | âœ… ì „í™˜ ë§¤ì¹­ Statement | - | DB ì „í™˜ ê²°ê³¼ |
| `compensation-events` â­ | - | âœ… ë³´ìƒ ì²˜ë¦¬ â­ | DB ì”ì•¡ ë³µêµ¬ |

### **ğŸ¯ í•µì‹¬ íë¦„**

**âœ… ìµœì í™”**:
```
Flink â†’ Redis/DB ì§ì ‘ ì—…ë°ì´íŠ¸
Worker â†’ DB ì§ì ‘ ì—…ë°ì´íŠ¸
```
---

## ğŸš€ ìµœì í™”ëœ ë°ì´í„° í”Œë¡œìš°

### **1. Campaign Events í”Œë¡œìš°**
```mermaid
graph LR
    Admin[ì–´ë“œë¯¼] --> API[API ì„œë²„]
    API --> K1[campaign-events]
    K1 --> F1[Flink RTB Statement]
    F1 --> R1[Redis ìˆœìœ„ ìºì‹œ]
```

### **2. Ad Events í”Œë¡œìš° (ë‹¤ì¤‘ ì†Œë¹„ + ì¤‘ë³µ ì²˜ë¦¬)**
```mermaid
graph TB
    API[API ì„œë²„] --> K2[ad-events]
    
    K2 --> F2[Flink ì„±ê³¼ Statement]
    K2 --> F3[Flink ì „í™˜ Statement]
    K2 --> F4[Flink ì¤‘ë³µ íƒì§€ Statement] 
    K2 --> W1[Worker ì”ì•¡ ì²˜ë¦¬]
    K2 --> W2[Worker ì˜ˆì‚° ëª¨ë‹ˆí„°ë§]
    
    F2 --> R2[Redis ì§€í‘œ ìºì‹œ]
    F3 --> DB1[(DB ì „í™˜ ê²°ê³¼)]
    F4 --> K4[compensation-events]
    W1 --> DB2[(DB ì”ì•¡ ì´ë ¥)]
    W2 --> R3[Redis ì˜ˆì‚° ì¹´ìš´í„°]
    W2 --> DB3[(DB ìº í˜ì¸ ìƒíƒœ)]
    
    K4 --> W3[Worker ë³´ìƒ ì²˜ë¦¬]
    W3 --> DB4[(DB ì”ì•¡ ë³µêµ¬)]
```

### **3. Conversion Events í”Œë¡œìš°**
```mermaid
graph LR
    EXT[ì™¸ë¶€ ì‹œìŠ¤í…œ] --> API[API ì„œë²„]
    API --> K3[conversion-events]
    K3 --> F3[Flink ì „í™˜ Statement]
    F3 --> DB[(DB ì „í™˜ ê²°ê³¼)]
```

### **4. Compensation Events í”Œë¡œìš° â­ ì‹ ê·œ**
```mermaid
graph LR
    F4[Flink ì¤‘ë³µ íƒì§€] --> K4[compensation-events]
    K4 --> W3[Worker ë³´ìƒ ì²˜ë¦¬]
    W3 --> DB[DB ì”ì•¡ ë³µêµ¬]
```

---

## ğŸ“Š ìµœì¢… í† í”½ êµ¬ì„±

| í† í”½ëª… | ìš°ì„ ìˆœìœ„ | TPS ì˜ˆìƒ | ë³´ê´€ê¸°ê°„ | íŒŒí‹°ì…˜ ìˆ˜ | Consumer Group |
|--------|----------|----------|----------|-----------|----------------|
| `campaign-events` | **P0** | 50 | 7ì¼ | 4 | `flink-rtb-processor` |
| `ad-events` | **P0** | 1000 | 7ì¼ | 8 | `flink-performance-aggregator`<br/>`flink-duplicate-detector` â­<br/>`worker-balance-processor` |
| `conversion-events` | **P1** | 100 | 3ì¼ | 4 | `flink-conversion-matcher` |
| `compensation-events` | **P1** | 20 | 3ì¼ | 4 | `worker-compensation-processor` â­ |

### **ë°œí–‰ ì£¼ì²´ë³„ ë§¤í•‘**

| ë°œí–‰ ì£¼ì²´ | í† í”½ | ë°œí–‰ ì‹œì  | ë°°ì¹˜ í¬ê¸° |
|-----------|------|-----------|-----------|
| **API ì„œë²„** | `campaign-events` | ìº í˜ì¸ ë“±ë¡/ìˆ˜ì •/ìŠ¹ì¸ ì‹œ | ë‹¨ì¼ ì´ë²¤íŠ¸ |
| **API ì„œë²„** | `ad-events` | ì‹¤ì‹œê°„ ì‚¬ìš©ì í–‰ë™ | ë‹¨ì¼ ì´ë²¤íŠ¸ |
| **API ì„œë²„** | `conversion-events` | ì „í™˜ ë°œìƒ ì‹œ | ë‹¨ì¼ ì´ë²¤íŠ¸ |
| **Flink Statement 4** | `compensation-events` | ì¤‘ë³µ í´ë¦­ íƒì§€ ì‹œ | ë‹¨ì¼ ì´ë²¤íŠ¸ â­ |

**ğŸ“‹ ìº í˜ì¸ ìŠ¹ì¸ í”Œë¡œìš°**:
```
1. ì–´ë“œë¯¼ ìŠ¹ì¸ â†’ API ì„œë²„
2. campaign-events í† í”½ CAMPAIGN_APPROVED ë°œí–‰
3. Flink RTB Statement ì¦‰ì‹œ ì²˜ë¦¬
4. placementë³„ ìºì‹œ ì—…ë°ì´íŠ¸ (rtb:HOME:electronics ë“±)
5. ê²½ìŸ ìº í˜ì¸ë“¤ ìˆœìœ„ ìë™ ì¬ì¡°ì •
```

---

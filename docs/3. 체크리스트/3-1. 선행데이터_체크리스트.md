# CPC 광고 시스템 선행데이터 체크리스트

> **📅 작성일**: 2024-01-15  
> **🎯 목적**: PO와 핵심 정책 결정 및 선행 데이터 요구사항 논의  
---

## ✅ **이미 결정된 정책들**

### **📋 RTB 알고리즘 정책 (확정)**

#### **1. 핵심 공식 및 파라미터**
- **노출 점수 공식**: `S_α(a,i) = B(a,i) × CTR + α × CTR × CVR × P`
- **가격 산정 공식**: `Pricing(a,n) = min(B(a,n), B(a,n+1))`
- **기본 파라미터 설정**:
  - `α = 0.1` (전환율 가중치)
  - `π = 24시간` (데이터 수집 기간)
  - `ω1 = 100회` (CTR 계산 최소 노출 임계값)
  - `ω2 = 10회` (CVR 계산 최소 클릭 임계값)
  - `δ = 'avg'` (방어값 산정 방식: 평균값 사용)

#### **2. 전환 추적 정책**
- **전환 인정 기준**: 클릭 후 **24시간 내 주문**만 인정
- **기여도 모델**: **Last-Click Attribution** (세션 내 가장 최근 클릭에 기여)
- **매칭 기준**: `mobile_device_id` 기준 매칭
- **중복 배분**: 클릭 수 기준 가중평균 적용

#### **3. 방어로직 정책**
- **데이터 부족 판단 기준**:
  - 노출수 < 100회 OR 클릭수 < 10회
- **방어값 적용 방식**:
  - CTR/CVR 부족 시 **카테고리 평균값** 사용
  - 방어로직 적용 캠페인은 Redis에 기록
  - 12시간마다 방어값 통계 업데이트

### **⚡ 시스템 성능 정책 (확정)**

#### **1. 응답 시간 목표**
- **API 응답**: Cache Hit 3-5ms, Cache Miss 15-20ms
- **처리량**: 1000 RPS 이상
- **클릭 처리**: Worker 50ms 이내 잔액 차감

#### **2. 데이터 보관 정책**
- **클릭 이력**: 24시간 TTL (`ad_impression_pricings`)
- **실시간 메트릭**: 7일 보관 (`ad_performance_metrics_realtime`)
- **성과 집계**: 5분 윈도우 (Flink Statement)
- **전환 매칭**: 24시간 윈도우 (Flink Statement)

#### **3. 예산 모니터링 정책**
- **경고 임계값**: 일일 예산 90% 소진 시 알림
- **자동 중단**: 일일 예산 100% 소진 시 캠페인 자동 중지
- **잔액 알림**: 기본 10,000원 미만 시 알림

### **🛡️ 사기 방지 정책 (확정)**

#### **1. 중복 클릭 탐지**
- **탐지 윈도우**: 5분 텀블링 윈도우
- **보상 처리**: Flink 자동 탐지 → compensation-events 발행 → Worker 잔액 복구
- **보상 공식**: `refund_amount = (duplicate_count - 1) × click_price`

#### **2. 품질 관리 기준**
- **필터링 조건**:
  - 잔액 > 0
  - 승인/유효 캠페인
  - 일예산 초과 없음
  - 품절 상품 제외

---

## 🚨 **정책 결정 필요한 사항**

### **Case 1: 주문 취소 시나리오**

**📋 상황 설명:**
```
14:00 - A 유저가 aa 상품 광고 클릭 (광고비 1,000원 차감)
15:00 - A 유저가 aa 상품 주문 완료 (전환 처리)
16:00 - A 유저가 주문 취소 요청
```

**🔥 결정 필요 사항:**

| 항목 | Option A (보수적) | Option B (공격적) | Option C (절충안) |
|------|------------------|------------------|------------------|
| **광고비 환불** | 100% 환불 | 환불 없음 | 24시간 내만 환불 |
| **성과 지표** | CVR/ROAS에서 제거 | 유지 | 24시간 내만 제거 |
| **수익 임팩트** | 광고주 유리 | 플랫폼 유리 | 균형 |
| **구현 복잡도** | 높음 | 낮음 | 중간 |

**💰 비즈니스 임팩트:**
- **월 예상 취소율**: 5-10% (일반 이커머스 기준)
- **월 광고비 영향**: Option A 선택 시 5-10% 감소 예상

---

### **Case 2: 중복 주문 시나리오**

**📋 상황 설명:**
```
14:00 - A 유저가 aa 상품 광고 클릭
15:00 - A 유저가 aa 상품 1개 주문 (120,000원)
16:00 - A 유저가 aa 상품 1개 추가 주문 (120,000원)  
17:00 - A 유저가 aa 상품 1개 추가 주문 (120,000원)
총 매출: 360,000원, 클릭 1회
```

**🔥 결정 필요 사항:**

| 항목 | Option A (중복 제거) | Option B (매출 중심) | Option C (절충안) |
|------|---------------------|---------------------|------------------|
| **전환 횟수** | 1번 | 3번 | 1번 (24시간 내) |
| **기여 매출** | 120,000원 | 360,000원 | 120,000원 |
| **CVR 계산** | 1/1 = 100% | 3/1 = 300% | 1/1 = 100% |
| **ROAS 계산** | 120배 | 360배 | 120배 |
| **광고주 만족도** | 낮음 | 높음 | 중간 |

**💰 비즈니스 임팩트:**
- **광고주 ROAS 기대치**: 높은 ROAS 수치로 광고 투자 증가 기대
- **성과 지표 왜곡**: 비현실적 CVR/ROAS로 인한 의사결정 오류 우려

---

## 📋 **선행 데이터 요구사항**

### **1. 외부 시스템 연동 토픽**

| 토픽명 | 스키마 | 제공 시스템 | 상태 | 비고 |
|--------|--------|-------------|------|------|
| `order.completed` | `{user_id, mobile_device_id, order_id}` | 주문 시스템 | ✅ 확인됨 | 전환 매칭용 |
| `order.cancelled` | `{user_id, order_id, cancel_reason}` | 주문 시스템 | ❓ 미확인 | **취소 정책 결정 후 필요** |
| `product.inventory` | `{product_id, stock_quantity}` | 재고 시스템 | ❓ 미확인 | 품절 광고 제외용 |
| `user.sessions` | `{user_id, session_id, device_id}` | 세션 시스템 | ❓ 미확인 | 세션 매칭용 |

### **2. 기존 데이터베이스 테이블**

| 테이블명 | 필요 컬럼 | 소유 시스템 | 상태 | 비고 |
|----------|-----------|-------------|------|------|
| `products` | `id, name, category_id, price, status` | 상품 시스템 | ❓ 미확인 | RTB 필터링용 |
| `categories` | `id, name, parent_id, level` | 상품 시스템 | ❓ 미확인 | 카테고리 매칭용 |
| `orders` | `id, user_id, product_id, amount, status` | 주문 시스템 | ❓ 미확인 | 매출 검증용 |
| `users` | `id, device_id, status` | 회원 시스템 | ❓ 미확인 | 사용자 매칭용 |

### **3. Redis 캐시 설계**

| 캐시 키 | 데이터 구조 | TTL | 목적 | 상태 |
|---------|-------------|-----|------|------|
| `rtb:{placement}:{category}` | Sorted Set | 5분 | RTB 순위 캐시 | 🚀 설계 완료 |
| `balance:{advertiser_id}` | Hash | 1시간 | 잔액 캐시 | 🚀 설계 완료 |
| `product:{product_id}:metrics` | Hash | 10분 | 성과 지표 캐시 | 🚀 설계 완료 |
| `campaign:{campaign_id}:budget` | Hash | 1시간 | 예산 추적 캐시 | 🚀 설계 완료 |

### **4. 필수 마스터 데이터**

| 데이터 유형 | 필요 정보 | 담당 부서 | 상태 |
|-------------|-----------|-----------|------|
| **광고주 데이터** | 기존 거래처 정보, 신용 한도 | 영업팀 | ❓ 미확인 |
| **카테고리 매핑** | 4단계 카테고리 구조, 경로 | 상품팀 | ❓ 미확인 |
| **초기 파라미터** | α=0.1, π=30일, ω1/ω2 임계값 | 데이터팀 | ❓ 미확인 |
| **방어값 통계** | 카테고리별 평균 CTR/CVR | 데이터팀 | ❓ 미확인 |

---

## 🤔 **추가 정책 논의 필요 사항**

### **1. 광고비 정산 정책**

**🔥 논의 필요:**
- **정산 주기**: 일정산 vs 주정산 vs 월정산
- **정산 기준**: 클릭 기준 vs 전환 기준
- **미지급 한도**: 최대 미지급 금액 설정
- **연체 처리**: 잔액 부족 시 광고 중단 시점

**💰 비즈니스 임팩트**: 현금 흐름 및 리스크 관리

### **2. 품질 관리 정책**

**🔥 논의 필요:**
- **저품질 광고 기준**: CTR < 1%, CVR < 0.1% 등
- **자동 중단 정책**: 연속 저성과 시 자동 중단 여부
- **품질 점수 계산**: 가중치 및 업데이트 주기
- **신규 광고 우대**: 신규 광고주 혜택 정책

**💰 비즈니스 임팩트**: 플랫폼 품질 및 사용자 경험

### **3. 실험 및 개인화 정책**

**🔥 논의 필요:**
- **A/B 테스트 범위**: 가격 vs 알고리즘 vs UI
- **개인화 수준**: 브라우징 이력 vs 구매 이력 활용 범위
- **프라이버시 정책**: 개인정보 활용 가이드라인
- **실험 기간**: 최소/최대 실험 기간 설정

**💰 비즈니스 임팩트**: 향후 수익성 개선 및 차별화

### **4. 사기 방지 정책**

**🔥 논의 필요:**
- **클릭 사기 탐지**: 중복 클릭, 봇 트래픽 기준
- **전환 사기 탐지**: 허위 주문, 즉시 취소 패턴
- **제재 조치**: 경고 vs 정지 vs 영구 제재
- **이의 제기**: 잘못된 제재에 대한 이의 절차

**💰 비즈니스 임팩트**: 플랫폼 신뢰도 및 수익성 보호

---


## 💡 **PO 결정 요청 사항**

### **즉시 결정 필요 (이번 주)**
1. **Case 1**: 주문 취소 시 광고비 환불 정책
2. **Case 2**: 중복 주문 시 전환 인정 정책
3. **외부 연동**: order.cancelled 토픽 필요 여부
4. **정산 주기**: 일정산 vs 주정산 선택
5. **품질 기준**: 저품질 광고 자동 중단 기준
6. **마스터 데이터**: 기존 시스템 연동 범위


# Worker ì„œë²„ êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸ (ê°„ë‹¨í•œ ì‘ì—… ì „ìš©)

> **ğŸ¯ Worker í•µì‹¬ ì±…ì„**: Flinkì—ì„œ ì´ê´€ëœ **ê°„ë‹¨í•œ ì‹¤ì‹œê°„ ì‘ì—…** ì²˜ë¦¬
> **âš¡ ì„¤ê³„ ì›ì¹™**: ë³µì¡í•œ ì‘ì—…ì€ Flink, ê°„ë‹¨í•œ ì‘ì—…ì€ Worker

---

## ğŸš€ í•µì‹¬ ì‘ì—… (Flinkì—ì„œ ì´ê´€)

### âœ… **1. ì‹¤ì‹œê°„ ì”ì•¡ ì°¨ê° ì²˜ë¦¬**

**ğŸ¯ ëª©ì **: í´ë¦­ ì´ë²¤íŠ¸ ì¦‰ì‹œ ì²˜ë¦¬ë¡œ ì‹¤ì‹œê°„ì„± ë³´ì¥ (ì¤‘ë³µ ì²´í¬ ì—†ìŒ)

**ğŸ”§ ì²˜ë¦¬ ë¡œì§**
- [ ] **í† í”½**: `ad-events` (CLICK ì´ë²¤íŠ¸ë§Œ í•„í„°ë§)
- [ ] **ì¦‰ì‹œ ì²˜ë¦¬**: í´ë¦­ ë°œìƒ ì¦‰ì‹œ ê´‘ê³ ì£¼ ì”ì•¡ ì°¨ê° (ì¤‘ë³µ ì²´í¬ ì—†ì´)
- [ ] **ë‹¨ìˆœ ë¡œì§**: ë³µì¡í•œ ê³„ì‚° ì—†ì´ ë‹¨ê°€ Ã— 1íšŒ ì°¨ê°
- [ ] **DB ì—…ë°ì´íŠ¸**: `ad_balance_histories` í…Œì´ë¸” INSERT
- [ ] **ì¤‘ë³µ ì²˜ë¦¬**: Flink Statement 4ì—ì„œ í›„ì²˜ë¦¬ë¡œ ë³´ìƒ

```java
// ğŸ”¥ ê°„ë‹¨í•œ í´ë¦­ ì²˜ë¦¬ ë¡œì§ (ì¤‘ë³µ ì²´í¬ ì—†ìŒ)
@KafkaListener(topics = "ad-events")
public void processClick(AdEvent event) {
    if (event.getEventType().equals("CLICK")) {
        // 1. ë‹¨ê°€ ì¡°íšŒ (Redis ìºì‹œ)
        BigDecimal cpc = redisCacheService.getCPC(event.getCampaignId());
        
        // 2. ì¦‰ì‹œ ì”ì•¡ ì°¨ê° (ì¤‘ë³µ ì²´í¬ ì—†ì´)
        balanceService.deductBalance(event.getAdvertiserId(), cpc);
        
        // 3. ì´ë ¥ ê¸°ë¡ (DEDUCT íƒ€ì…)
        balanceHistoryService.insertHistory(event, cpc, "DEDUCT");
        
        // Note: ì¤‘ë³µ í´ë¦­ì€ Flinkì—ì„œ 5ë¶„ ìœˆë„ìš°ë¡œ íƒì§€ í›„ ë³´ìƒ ì²˜ë¦¬
    }
}
```

**ğŸ“ í•µì‹¬ ìš”êµ¬ì‚¬í•­**
- [ ] **Consumer Group**: `click-balance-processor`
- [ ] **ì²˜ë¦¬ ì‹œê°„**: < 50ms (ì‹¤ì‹œê°„)
- [ ] **ì—ëŸ¬ ì²˜ë¦¬**: ì‹¤íŒ¨ ì‹œ DLQ ì „ì†¡
- [ ] **ì¤‘ë³µ ì²˜ë¦¬**: Flinkì—ì„œ í›„ì²˜ë¦¬ (WorkerëŠ” ì¤‘ë³µ ì²´í¬ ì•ˆí•¨)

---

### âœ… **2. ì˜ˆì‚° ëª¨ë‹ˆí„°ë§ (ì‹¤ì‹œê°„)**

**ğŸ¯ ëª©ì **: Redis ì˜ˆì‚° ì¹´ìš´í„° ëª¨ë‹ˆí„°ë§ ë° ì„ê³„ê°’ ì²´í¬

**ğŸ”§ ëª¨ë‹ˆí„°ë§ ë¡œì§**
- [ ] **ì‹¤ì‹œê°„ ì²´í¬**: ì”ì•¡ ì°¨ê° í›„ ì¦‰ì‹œ ì˜ˆì‚° ìƒíƒœ í™•ì¸
- [ ] **ì„ê³„ê°’ ì„¤ì •**: ì¼ì˜ˆì‚° 90% ì†Œì§„ ì‹œ ì•Œë¦¼, 100% ì‹œ ìº í˜ì¸ ì¤‘ì§€
- [ ] **Redis ì¡°íšŒ**: `daily_budget:{campaign_id}` ì¹´ìš´í„° í™•ì¸
- [ ] **ìƒíƒœ ë³€ê²½**: ì˜ˆì‚° ì†Œì§„ ì‹œ ìº í˜ì¸ ìƒíƒœ PAUSEDë¡œ ë³€ê²½

```java
// ğŸ”¥ ê°„ë‹¨í•œ ì˜ˆì‚° ëª¨ë‹ˆí„°ë§
public void checkBudgetAfterClick(Long campaignId, BigDecimal spentAmount) {
    // 1. í˜„ì¬ ì‚¬ìš©ëŸ‰ ì¡°íšŒ
    BigDecimal totalSpent = redisService.getSpentAmount(campaignId);
    BigDecimal dailyBudget = campaignService.getDailyBudget(campaignId);
    
    // 2. ì‚¬ìš©ë¥  ê³„ì‚°
    double usageRate = totalSpent.divide(dailyBudget).doubleValue();
    
    // 3. ì„ê³„ê°’ ì²´í¬
    if (usageRate >= 1.0) {
        campaignService.pauseCampaign(campaignId, "BUDGET_EXHAUSTED");
    } else if (usageRate >= 0.9) {
        notificationService.sendBudgetWarning(campaignId, usageRate);
    }
}
```

**ğŸ“ í•µì‹¬ ìš”êµ¬ì‚¬í•­**
- [ ] **ëª¨ë‹ˆí„°ë§ ì£¼ê¸°**: í´ë¦­ ë°œìƒ ì‹œë§ˆë‹¤ ì¦‰ì‹œ
- [ ] **ì„ê³„ê°’**: 90% ê²½ê³ , 100% ìë™ ì¤‘ì§€
- [ ] **ì•Œë¦¼**: Slack/Email ì¦‰ì‹œ ì•Œë¦¼
- [ ] **ë³µêµ¬**: ë‹¤ìŒë‚  ìë™ ì¬ê°œ (ì¼ì˜ˆì‚° ë¦¬ì…‹)

---

### âœ… **3. ë³´ìƒ ì²˜ë¦¬ (ì¤‘ë³µ í´ë¦­ í™˜ë¶ˆ) â­ ì‹ ê·œ**

**ğŸ¯ ëª©ì **: Flinkì—ì„œ íƒì§€í•œ ì¤‘ë³µ í´ë¦­ì— ëŒ€í•œ ì”ì•¡ ë³µêµ¬

**ğŸ”§ ì²˜ë¦¬ ë¡œì§**
- [ ] **í† í”½**: `compensation-events` (Flink Statement 4ì—ì„œ ë°œí–‰)
- [ ] **ì¦‰ì‹œ ì²˜ë¦¬**: ë³´ìƒ ì´ë²¤íŠ¸ ì¦‰ì‹œ ì²˜ë¦¬ë¡œ ì‹¤ì‹œê°„ í™˜ë¶ˆ
- [ ] **ë‹¨ìˆœ ë¡œì§**: í™˜ë¶ˆ ê¸ˆì•¡ë§Œí¼ ì”ì•¡ ë³µêµ¬
- [ ] **DB ì—…ë°ì´íŠ¸**: `ad_balance_histories` í…Œì´ë¸” INSERT (REFUND íƒ€ì…)

```java
// ğŸ”¥ ê°„ë‹¨í•œ ë³´ìƒ ì²˜ë¦¬ ë¡œì§
@KafkaListener(topics = "compensation-events")
public void processCompensation(CompensationEvent event) {
    // 1. í™˜ë¶ˆ ê¸ˆì•¡ í™•ì¸
    BigDecimal refundAmount = event.getRefundAmount();
    
    // 2. ì”ì•¡ ë³µêµ¬
    balanceService.addBalance(event.getAdvertiserId(), refundAmount);
    
    // 3. ì´ë ¥ ê¸°ë¡ (REFUND íƒ€ì…)
    balanceHistoryService.insertRefundHistory(event, refundAmount, "REFUND");
    
    // 4. ì¤‘ë³µ í´ë¦­ ë¡œê·¸ ê¸°ë¡
    duplicateLogService.logDuplicateClick(event);
}
```

**ğŸ“ í•µì‹¬ ìš”êµ¬ì‚¬í•­**
- [ ] **Consumer Group**: `compensation-processor`
- [ ] **ì²˜ë¦¬ ì‹œê°„**: < 50ms (ì‹¤ì‹œê°„)
- [ ] **ì—ëŸ¬ ì²˜ë¦¬**: ì‹¤íŒ¨ ì‹œ DLQ ì „ì†¡ ë° ì•Œë¦¼
- [ ] **ëª¨ë‹ˆí„°ë§**: ì¤‘ë³µ í´ë¦­ ë°œìƒë¥  ëª¨ë‹ˆí„°ë§

---

## âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì • (ìµœì†Œ êµ¬ì„±)

### âœ… **3. Kafka Consumer ì„¤ì •**

**ğŸ”§ ad-events Consumer ì„¤ì •**
- [ ] **Topic**: `ad-events` 
- [ ] **Consumer Group**: `click-balance-processor`
- [ ] **Parallelism**: 3ê°œ (ì‹¤ì‹œê°„ ì²˜ë¦¬ìš©)
- [ ] **Auto Commit**: false (ìˆ˜ë™ ì»¤ë°‹)
- [ ] **ì²˜ë¦¬ ìš°ì„ ìˆœìœ„**: P1 (ìµœê³  ìš°ì„ ìˆœìœ„)

```yaml
# ğŸ”¥ Kafka Consumer ì„¤ì •
spring:
  kafka:
    consumer:
      group-id: click-balance-processor
      auto-offset-reset: latest
      enable-auto-commit: false
      max-poll-records: 100  # ì†ŒëŸ‰ ë°°ì¹˜ë¡œ ì‹¤ì‹œê°„ì„± ë³´ì¥
      session-timeout-ms: 30000
```

---

### âœ… **4. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • (ê°„ë‹¨)**

**ğŸ”§ í•„ìˆ˜ í…Œì´ë¸”**
- [ ] **ad_balance_histories**: ì”ì•¡ ì°¨ê° ì´ë ¥ ì €ì¥
- [ ] **campaigns**: ìº í˜ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸

---

### âœ… **5. Redis ì—°ë™ (ì½ê¸° ì „ìš©)**

**ğŸ”§ ì˜ˆì‚° ì¹´ìš´í„° ì¡°íšŒ**
- [ ] **ì½ê¸° ì „ìš©**: WorkerëŠ” Redis ì½ê¸°ë§Œ ìˆ˜í–‰
- [ ] **ìºì‹œ í‚¤**: `daily_budget:{campaign_id}`, `cpc:{campaign_id}`
- [ ] **ì¥ì•  ì²˜ë¦¬**: Redis ì‹¤íŒ¨ ì‹œ DB ì¡°íšŒë¡œ í´ë°±

---

> **ğŸ”¥ ê²°ë¡ **: WorkerëŠ” **ê°„ë‹¨í•˜ê³  ë¹ ë¥¸ ì‹¤ì‹œê°„ ì²˜ë¦¬**ì—ë§Œ ì§‘ì¤‘í•˜ì—¬ ìµœì ì˜ ì„±ëŠ¥ ë‹¬ì„±! 
# 시스템 컴포넌트 역할 분담 요약

> **단순화 완료**: API 직접 차감 + 4개 토픽으로 역할 재정의 및 최적화

---

## 🎯 **컴포넌트별 핵심 책임**

### 🚀 **API 서버** 
**책임**: HTTP 요청 처리, RTB 로직, 즉시 잔액 차감, 이벤트 발행, 즉시 응답

**담당 업무:**
- ✅ **RTB 로직** (광고 요청 + 할당 + 가격 결정)
  - 검색어/카테고리 기반 캠페인 필터링
  - Redis 일예산 카운터 실시간 체크
  - 가격 실험 매핑 테이블 조회
- ✅ **즉시 잔액 차감** (원자적 트랜잭션)
  - 클릭 발생 시 DB 즉시 차감
  - Redis 일예산 카운터 실시간 업데이트
  - 차감 성공/실패 즉시 응답
- ✅ **이벤트 추적 API** (노출/클릭/전환)
- ✅ **어드민 API** (광고주/캠페인/광고 관리)
- ✅ **Kafka Producer** (분석용 이벤트 발송)

**처리하지 않는 것:**
- ❌ 복잡한 집계 계산
- ❌ 이벤트 매칭
- ❌ 배치 처리

---

### ⚡ **Flink 스트림 처리**
**책임**: 실시간 스트림 처리, 이벤트 매칭, 윈도우 집계, 예산 동기화, 이상 감지

**담당 업무:**
- ✅ **실시간 성과 지표 집계** (CTR, CVR, CPC)
  - 1분/5분/1시간 윈도우 집계
  - Redis 직접 업데이트
- ✅ **클릭-전환 매칭** (CEP 기반 24시간 윈도우)
- ✅ **예산 동기화** (10분마다)
  - Redis 카운터 vs DB 실제 차감액 비교
  - 5% 이상 오차 시 자동 보정
  - 95% 예산 소진 시 캠페인 자동 일시정지
- ✅ **실시간 이상 감지** (봇 트래픽, 클릭 폭증)
- ✅ **품질 점수 업데이트** (성과 기반 자동 조정)

**출력:**
- Redis: 실시간 지표 (`ad:{id}:metrics:1m`)
- Kafka: 집계 결과 (`performance-metrics`)
- Kafka: 예산 동기화 (`budget-management`)
- Kafka: 품질 점수 (`quality-score-updates`)

---

### 🔧 **Worker 서버**
**책임**: Flink 결과 처리, 배치 집계, 예산 정산, 데이터 정합성 관리

**담당 업무:**
- ✅ **Flink 결과 수신** (성과 집계 결과 DB 저장)
- ✅ **예산 동기화 처리** (Redis 카운터 보정 및 캠페인 제어)
- ✅ **품질 점수 업데이트** (DB 최종 저장 및 이력 기록)
- ✅ **일일 배치 집계** (Flink 결과 기반 최종 정산)
- ✅ **예산 정산** (Redis vs DB 일일 대조)
- ✅ **데이터 정합성 모니터링** (Flink vs Worker 집계 비교)
- ✅ **데이터 정리** (90일 후 원시 데이터 삭제)

**처리하지 않는 것:**
- ❌ 클릭 차감 처리 (→ API에서 직접 처리)
- ❌ 실시간 집계 (→ Flink로 이관)
- ❌ 실시간 캐시 업데이트 (→ Flink에서 직접 Redis 업데이트)

---

## 🔄 **데이터 플로우 (4개 Topic)**

### **실시간 처리 플로우**
```
API 서버 → Kafka `ad-events` → Flink 스트림 처리 → Redis (실시간 지표)
                                             ↓
                                   Kafka `performance-metrics` → Worker (최종 DB 저장)
```

### **차감 처리 플로우 (단순화)**
```
클릭 API → 즉시 DB 차감 + Redis 카운터 업데이트 → 즉시 응답
        ↓
   Kafka `ad-events` (분석용)
```

### **예산 동기화 플로우**
```
Flink (10분마다) → Redis vs DB 비교 → Kafka `budget-management` → Worker (보정 처리)
```

### **품질 점수 플로우**
```
Flink (성과 분석) → Kafka `quality-score-updates` → Worker (DB 업데이트)
```

---

## 📊 **Kafka Topic 구조 (4개로 단순화)**

### **ad-events** (P0 - 최우선)
- **용도**: 노출, 클릭, 전환 통합 이벤트
- **생산자**: API 서버
- **소비자**: Flink 스트림 처리
- **보관기간**: 7일
- **파티션**: 12개

### **performance-metrics** (P0 - 최우선)
- **용도**: Flink 실시간 집계 결과
- **생산자**: Flink
- **소비자**: Worker
- **보관기간**: 30일
- **파티션**: 6개

### **budget-management** (P1 - 높음)
- **용도**: 예산 동기화 및 캠페인 제어
- **생산자**: Flink
- **소비자**: Worker
- **보관기간**: 7일
- **파티션**: 3개

### **quality-score-updates** (P2 - 보통)
- **용도**: 품질 점수 업데이트
- **생산자**: Flink
- **소비자**: Worker
- **보관기간**: 14일
- **파티션**: 3개

---

## 📊 **성능 및 확장성**

### **처리 용량**
- **API 서버**: 1,500 TPS (광고 요청) + 800 TPS (클릭 차감)
- **Flink**: 10,000+ 이벤트/초 (실시간 처리)
- **Worker**: 5,000 메시지/초 (집계 결과 처리)

### **응답 시간**
- **API 서버**: < 50ms (RTB) + < 20ms (차감)
- **Flink**: < 5초 (실시간 집계 지연)
- **Worker**: < 100ms (결과 처리)

### **가용성**
- **API 서버**: 99.9% (로드 밸런싱)
- **Flink**: 99.95% (HA + 체크포인트)
- **Worker**: 99.9% (자동 재시작)

### **정확성**
- **잔액 차감**: 99.8% 성공률 (즉시 처리)
- **예산 동기화**: 99.5% 정확도 (10분마다 보정)
- **집계 일치**: 95% 이상 (Flink vs Worker)

---

## 🚨 **모니터링 포인트**

### **API 서버**
- RTB 응답시간, 차감 성공률, Redis 응답시간
- Kafka Producer 지연시간

### **Flink**
- 처리량, 백프레셔, 체크포인트 성공률
- 예산 동기화 정확도, 이상 감지 알림 정확도

### **Worker**
- Consumer Lag, 집계 처리 속도
- Flink vs Worker 집계 일치율


---

## 🎉 **아키텍처 장점**

### **단순성**
- **즉시 처리**: 클릭 차감이 실시간으로 처리되어 사용자 경험 개선
- **명확한 역할**: 각 컴포넌트의 책임이 명확히 분리

### **안정성**
- **원자적 차감**: DB 트랜잭션으로 일관성 보장
- **자동 보정**: 10분마다 예산 카운터 정확도 보정
- **장애 격리**: 각 컴포넌트 장애가 다른 컴포넌트에 미치는 영향 최소화

### **확장성**
- **수평 확장**: 각 컴포넌트 독립적 스케일링 가능
- **성능 최적화**: 핫패스 (RTB + 차감)가 단일 컴포넌트에서 처리
- **유지보수**: 단순한 구조로 개발/운영 비용 절감

이제 **완전히 새로운 아키텍처**로 더욱 단순하고 안정적인 RTB 시스템이 완성되었습니다! 🚀 
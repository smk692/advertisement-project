# Flink ìµœì í™” ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬ êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

> **ğŸ¯ í•µì‹¬ ëª©í‘œ**: **ì—­í•  ë¶„ë‹´ ìµœì í™”** - ë³µì¡í•œ ì‘ì—…ë§Œ Flink, ê°„ë‹¨í•œ ì‘ì—…ì€ Worker  
> **ğŸ’¡ ì•„í‚¤í…ì²˜**: Flink 4ê°œ Statement (JOIN/WINDOW ì „ìš©) + Worker (ë‹¨ìˆœ ì²˜ë¦¬)

---

## ğŸ“Š **ìµœì í™”ëœ ì—­í•  ë¶„ë‹´**

### **ğŸ”¥ Flink ë‹´ë‹¹ (ë³µì¡í•œ ì‘ì—…)**
- **RTB ì¬ê³„ì‚°**: Campaign JOIN + ì•Œê³ ë¦¬ì¦˜ ê³„ì‚° + Redis ìºì‹œ
- **ì„±ê³¼ ì§‘ê³„**: 5ë¶„ WINDOW + CTR/CVR ê³„ì‚°  
- **ì „í™˜ ë§¤ì¹­**: 24ì‹œê°„ WINDOW + í´ë¦­-ì „í™˜ JOIN
- **ì¤‘ë³µ íƒì§€**: 5ë¶„ WINDOW + ì¤‘ë³µ í´ë¦­ íƒì§€ + ë³´ìƒ ì´ë²¤íŠ¸ ë°œí–‰ â­ ì‹ ê·œ

### **âš¡ Worker ë‹´ë‹¹ (ê°„ë‹¨í•œ ì‘ì—…)**
- **ì”ì•¡ ì°¨ê°**: í´ë¦­ ì´ë²¤íŠ¸ â†’ DB INSERT (ì‹¤ì‹œê°„, ì¤‘ë³µ ì²´í¬ ì—†ìŒ)
- **ì˜ˆì‚° ëª¨ë‹ˆí„°ë§**: Redis ì¹´ìš´í„° ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„)
- **ìº í˜ì¸ ìƒíƒœ**: ì˜ˆì‚° ì†Œì§„ ì‹œ ìƒíƒœ ë³€ê²½ (ë°°ì¹˜)
- **ë³´ìƒ ì²˜ë¦¬**: compensation-events â†’ DB ì”ì•¡ ë³µêµ¬ â­ ì‹ ê·œ

---

## ğŸš€ Flink Statement êµ¬ì„± (4ê°œ)

### **âœ… Statement 1: RTB_CACHE_UPDATER**

```sql
-- ğŸ¯ RTB ìˆœìœ„ ê³„ì‚° ë° Redis ìºì‹œ ì—…ë°ì´íŠ¸ (ë³µì¡í•œ JOIN + ì•Œê³ ë¦¬ì¦˜)

CREATE TABLE campaign_events_source (
  event_type STRING,
  timestamp_field TIMESTAMP(3),
  campaign_id BIGINT,
  advertiser_id BIGINT, 
  product_id BIGINT,
  placement STRING,
  category STRING,
  bid_price DECIMAL(10,2),
  status STRING,
  WATERMARK FOR timestamp_field AS timestamp_field - INTERVAL '30' SECOND
) WITH (
  'connector' = 'kafka',
  'topic' = 'campaign-events',
  'properties.bootstrap.servers' = '${KAFKA_BROKERS}',
  'properties.group.id' = 'flink-rtb-processor',
  'format' = 'json'
);

-- ğŸ¯ RTB ì ìˆ˜ ê³„ì‚° ë° ìˆœìœ„ ìºì‹œ ìƒì„±
-- ëª©ì : ìº í˜ì¸ ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ìœ¼ë¡œ RTB ìˆœìœ„ë¥¼ ì¬ê³„ì‚°í•˜ì—¬ Redisì— ì €ì¥
INSERT INTO rtb_ranking_cache
SELECT 
  placement,                    -- ê´‘ê³  ì˜ì—­ (HOME, CATEGORY, SEARCH ë“±)
  category,                     -- ìƒí’ˆ ì¹´í…Œê³ ë¦¬ (electronics, fashion ë“±)
  
  -- ğŸ“Š RTB ìˆœìœ„ ë¦¬ìŠ¤íŠ¸ ìƒì„± (ì ìˆ˜ìˆœ ì •ë ¬)
  COLLECT(
    ROW(
      product_id,               -- ê´‘ê³  ìƒí’ˆ ID
      -- ğŸ§® S_Î± ì ìˆ˜ ê³„ì‚°: ì…ì°°ê°€ Ã— CTR + Î± Ã— CTR Ã— CVR Ã— ìƒí’ˆê°€ê²© 
      -- Î±=0.1: ì „í™˜ìœ¨ ê°€ì¤‘ì¹˜, CTR/CVR ê¸°ë³¸ê°’ìœ¼ë¡œ ë°©ì–´ë¡œì§ ì ìš©
      bid_price * COALESCE(pm.ctr, 0.01) + 0.1 * COALESCE(pm.ctr, 0.01) * COALESCE(pm.cvr, 0.005) * pmd.product_price,
      bid_price,                -- ì›ë³¸ ì…ì°°ê°€
      campaign_id,              -- ìº í˜ì¸ ID
      advertiser_id             -- ê´‘ê³ ì£¼ ID
    ) 
    -- ğŸ“ˆ ì ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ë†’ì€ ì ìˆ˜ = ìƒìœ„ ë…¸ì¶œ)
    ORDER BY (bid_price * COALESCE(pm.ctr, 0.01) + 0.1 * COALESCE(pm.ctr, 0.01) * COALESCE(pm.cvr, 0.005) * pmd.product_price) DESC
  ) as ranking_list,
  
  COUNT(*) as total_campaigns,  -- í•´ë‹¹ ì˜ì—­ì˜ ì´ ê²½ìŸ ìº í˜ì¸ ìˆ˜
  CURRENT_TIMESTAMP as updated_at

FROM campaign_events_source c
-- ğŸ­ ì„±ê³¼ ë°ì´í„° ì¡°ì¸ (CTR/CVR ê°€ì ¸ì˜¤ê¸°, ì—†ìœ¼ë©´ ë°©ì–´ë¡œì§ ì ìš©)
LEFT JOIN product_metrics_cache pm ON c.product_id = pm.product_id
-- ğŸ’° ìƒí’ˆ ë©”íƒ€ë°ì´í„° ì¡°ì¸ (ìƒí’ˆ ê°€ê²© ì •ë³´)
LEFT JOIN product_meta_data pmd ON c.product_id = pmd.product_id

WHERE c.event_type IN ('CAMPAIGN_CREATE', 'CAMPAIGN_UPDATE', 'CAMPAIGN_ACTIVATE')
  AND c.status = 'ACTIVE'      -- í™œì„± ìº í˜ì¸ë§Œ RTB ê²½ìŸ ì°¸ì—¬
GROUP BY c.placement, c.category;
```

### **âœ… Statement 2: PERFORMANCE_AGGREGATOR**

```sql
-- ğŸ“Š ì‹¤ì‹œê°„ ì„±ê³¼ ì§‘ê³„ (5ë¶„ WINDOW + ë³µì¡í•œ ì§‘ê³„)

CREATE TABLE ad_events_source (
  event_type STRING,
  timestamp_field TIMESTAMP(3),
  campaign_id BIGINT,
  advertiser_id BIGINT,
  product_id BIGINT,
  placement STRING,
  category STRING,
  actual_price DECIMAL(10,2),
  revenue_amount DECIMAL(15,2),
  WATERMARK FOR timestamp_field AS timestamp_field - INTERVAL '10' SECOND
) WITH (
  'connector' = 'kafka',
  'topic' = 'ad-events',
  'properties.bootstrap.servers' = '${KAFKA_BROKERS}',
  'properties.group.id' = 'flink-performance-processor',
  'format' = 'json'
);

-- ğŸ“Š 5ë¶„ ìœˆë„ìš° ì„±ê³¼ ì§‘ê³„
-- ëª©ì : ì‹¤ì‹œê°„ìœ¼ë¡œ ê´‘ê³  ì„±ê³¼ë¥¼ ì§‘ê³„í•˜ì—¬ CTR/CVR ë“±ì„ ê³„ì‚°í•˜ê³  Redisì— ì €ì¥
INSERT INTO ad_performance_metrics_realtime
SELECT 
  ROW_NUMBER() OVER (ORDER BY window_start) as id,
  campaign_id,                  -- ìº í˜ì¸ ID
  product_id,                   -- ìƒí’ˆ ID
  placement,                    -- ê´‘ê³  ì˜ì—­
  DATE_FORMAT(window_start, 'yyyy-MM-dd HH:mm:ss') as metric_time,
  
  -- ğŸ“ˆ ê¸°ë³¸ ì§€í‘œ ì¹´ìš´íŒ…
  SUM(CASE WHEN event_type = 'IMPRESSION' THEN 1 ELSE 0 END) as impression_count, -- ë…¸ì¶œ ìˆ˜
  SUM(CASE WHEN event_type = 'CLICK' THEN 1 ELSE 0 END) as click_count,           -- í´ë¦­ ìˆ˜
  SUM(CASE WHEN event_type = 'CONVERSION' THEN 1 ELSE 0 END) as conversion_count, -- ì „í™˜ ìˆ˜
  
  -- ğŸ’° ë¹„ìš©/ìˆ˜ìµ ì§‘ê³„
  SUM(CASE WHEN event_type = 'CLICK' THEN actual_price ELSE 0 END) as total_spend,    -- ì´ ê´‘ê³ ë¹„
  SUM(CASE WHEN event_type = 'CONVERSION' THEN revenue_amount ELSE 0 END) as total_revenue, -- ì´ ë§¤ì¶œ
  
  -- ğŸ§® ì„±ê³¼ ì§€í‘œ ê³„ì‚° (0ìœ¼ë¡œ ë‚˜ëˆ„ê¸° ë°©ì§€)
  -- CTR (Click Through Rate): í´ë¦­ë¥  = (í´ë¦­ ìˆ˜ / ë…¸ì¶œ ìˆ˜) Ã— 100
  CASE 
    WHEN SUM(CASE WHEN event_type = 'IMPRESSION' THEN 1 ELSE 0 END) > 0
    THEN CAST(SUM(CASE WHEN event_type = 'CLICK' THEN 1 ELSE 0 END) AS DOUBLE) 
         / SUM(CASE WHEN event_type = 'IMPRESSION' THEN 1 ELSE 0 END) * 100
    ELSE 0 
  END as ctr,
  
  -- CVR (Conversion Rate): ì „í™˜ìœ¨ = (ì „í™˜ ìˆ˜ / í´ë¦­ ìˆ˜) Ã— 100
  CASE 
    WHEN SUM(CASE WHEN event_type = 'CLICK' THEN 1 ELSE 0 END) > 0
    THEN CAST(SUM(CASE WHEN event_type = 'CONVERSION' THEN 1 ELSE 0 END) AS DOUBLE) 
         / SUM(CASE WHEN event_type = 'CLICK' THEN 1 ELSE 0 END) * 100
    ELSE 0 
  END as cvr,
  
  -- ROAS (Return on Ad Spend): ê´‘ê³  ìˆ˜ìµë¥  = ì´ ë§¤ì¶œ / ì´ ê´‘ê³ ë¹„
  CASE 
    WHEN SUM(CASE WHEN event_type = 'CLICK' THEN actual_price ELSE 0 END) > 0
    THEN SUM(CASE WHEN event_type = 'CONVERSION' THEN revenue_amount ELSE 0 END) 
         / SUM(CASE WHEN event_type = 'CLICK' THEN actual_price ELSE 0 END)
    ELSE 0 
  END as roas,
  
  CURRENT_TIMESTAMP as updated_at

FROM TABLE(
  -- â° 5ë¶„ í…€ë¸”ë§ ìœˆë„ìš° (5ë¶„ë§ˆë‹¤ ì§‘ê³„)
  TUMBLE(TABLE ad_events_source, DESCRIPTOR(timestamp_field), INTERVAL '5' MINUTE)
)
WHERE campaign_id IS NOT NULL    -- ìœ íš¨í•œ ìº í˜ì¸ë§Œ ì§‘ê³„
GROUP BY campaign_id, product_id, placement, window_start;
```

### **âœ… Statement 3: CONVERSION_MATCHER**

```sql
-- ğŸ”— 24ì‹œê°„ í´ë¦­-ì „í™˜ ë§¤ì¹­ (ë³µì¡í•œ WINDOW + JOIN)

CREATE TABLE order_completed_source (
  user_id BIGINT,
  mobile_device_id STRING,
  order_id BIGINT,
  timestamp_field TIMESTAMP(3),
  WATERMARK FOR timestamp_field AS timestamp_field - INTERVAL '1' HOUR
) WITH (
  'connector' = 'kafka',
  'topic' = 'order.completed',
  'properties.bootstrap.servers' = '${KAFKA_BROKERS}',
  'properties.group.id' = 'flink-conversion-processor',
  'format' = 'json'
);

-- ğŸ”— 24ì‹œê°„ ìœˆë„ìš° í´ë¦­-ì „í™˜ ë§¤ì¹­
-- ëª©ì : ê´‘ê³  í´ë¦­ê³¼ ì£¼ë¬¸ ì™„ë£Œë¥¼ 24ì‹œê°„ ë‚´ì—ì„œ ë§¤ì¹­í•˜ì—¬ ì „í™˜ ì„±ê³¼ ì¸¡ì •
INSERT INTO conversion_attribution_results
SELECT 
  click_events.ad_id,               -- í´ë¦­ëœ ê´‘ê³  ID
  click_events.campaign_id,         -- ìº í˜ì¸ ID
  click_events.advertiser_id,       -- ê´‘ê³ ì£¼ ID
  click_events.product_id,          -- ìƒí’ˆ ID
  ord.order_id,                     -- ë§¤ì¹­ëœ ì£¼ë¬¸ ID
  0 as revenue_amount,              -- ğŸ’¡ order.completedì—ëŠ” revenue ì •ë³´ ì—†ìŒ (ë³„ë„ ì¡°íšŒ í•„ìš”)
  TIMESTAMPDIFF(SECOND, click_events.click_time, ord.timestamp_field) as time_to_conversion, -- í´ë¦­-ì „í™˜ ì‹œê°„ì°¨
  'LAST_CLICK' as attribution_model, -- ì–´íŠ¸ë¦¬ë·°ì…˜ ëª¨ë¸: ë§ˆì§€ë§‰ í´ë¦­ ê¸°ì—¬
  click_events.click_time,          -- í´ë¦­ ë°œìƒ ì‹œê°„
  ord.timestamp_field as conversion_time, -- ì „í™˜(ì£¼ë¬¸) ë°œìƒ ì‹œê°„
  CURRENT_TIMESTAMP as processed_at

FROM (
  -- ğŸ“± í´ë¦­ ì´ë²¤íŠ¸ 24ì‹œê°„ í˜¸í•‘ ìœˆë„ìš°
  -- ëª©ì : ê° ë””ë°”ì´ìŠ¤ë³„ ìƒí’ˆë³„ë¡œ ê°€ì¥ ìµœê·¼ í´ë¦­ì„ ì°¾ê¸°
  SELECT 
    ad_id,                          -- ê´‘ê³  ID
    campaign_id,                    -- ìº í˜ì¸ ID
    advertiser_id,                  -- ê´‘ê³ ì£¼ ID
    product_id,                     -- ìƒí’ˆ ID
    device_id,                      -- ë””ë°”ì´ìŠ¤ ID (mobile_device_idì™€ ë§¤ì¹­)
    session_id,                     -- ì„¸ì…˜ ID
    timestamp_field as click_time,  -- í´ë¦­ ì‹œê°„
    -- ğŸ† Last-Click Attribution: ê°™ì€ ë””ë°”ì´ìŠ¤+ìƒí’ˆì˜ ê°€ì¥ ìµœê·¼ í´ë¦­ ì„ íƒ
    ROW_NUMBER() OVER (
      PARTITION BY device_id, product_id 
      ORDER BY timestamp_field DESC  -- ì‹œê°„ ë‚´ë¦¼ì°¨ìˆœ (ìµœì‹  í´ë¦­ ìš°ì„ )
    ) as click_rank
  FROM TABLE(
    -- â° 24ì‹œê°„ í˜¸í•‘ ìœˆë„ìš° (1ì‹œê°„ ìŠ¬ë¼ì´ë“œ, 24ì‹œê°„ í¬ê¸°)
    HOP(TABLE ad_events_source, DESCRIPTOR(timestamp_field), INTERVAL '1' HOUR, INTERVAL '24' HOUR)
  )
  WHERE event_type = 'CLICK'        -- í´ë¦­ ì´ë²¤íŠ¸ë§Œ í•„í„°ë§
) click_events

-- ğŸ›’ ì£¼ë¬¸ ì™„ë£Œ ì´ë²¤íŠ¸ì™€ ì¡°ì¸
INNER JOIN order_completed_source ord
  ON ord.mobile_device_id = click_events.device_id  -- ê°™ì€ ë””ë°”ì´ìŠ¤ ê¸°ì¤€ ë§¤ì¹­
  AND ord.timestamp_field BETWEEN click_events.click_time AND click_events.click_time + INTERVAL '24' HOUR  -- 24ì‹œê°„ ìœˆë„ìš°

WHERE click_events.click_rank = 1   -- ê°€ì¥ ìµœê·¼ í´ë¦­ë§Œ ì„ íƒ (Last Click Attribution)
```

### **âœ… Statement 4: DUPLICATE_DETECTOR â­ ì‹ ê·œ**

```sql
-- ğŸ›¡ï¸ ì¤‘ë³µ í´ë¦­ íƒì§€ ë° ë³´ìƒ ì´ë²¤íŠ¸ ë°œí–‰ (5ë¶„ WINDOW + ë³µì¡í•œ GROUP BY)

CREATE TABLE ad_events_duplicate_source (
  event_type STRING,
  timestamp_field TIMESTAMP(3),
  device_id STRING,
  session_id STRING,
  user_id STRING,
  ad_id STRING,
  campaign_id BIGINT,
  advertiser_id BIGINT,
  product_id BIGINT,
  actual_price DECIMAL(10,2),
  WATERMARK FOR timestamp_field AS timestamp_field - INTERVAL '30' SECOND
) WITH (
  'connector' = 'kafka',
  'topic' = 'ad-events',
  'properties.bootstrap.servers' = '${KAFKA_BROKERS}',
  'properties.group.id' = 'flink-duplicate-detector',
  'format' = 'json'
);

-- ë³´ìƒ ì´ë²¤íŠ¸ ì¶œë ¥ í…Œì´ë¸”
CREATE TABLE compensation_events_sink (
  timestamp_field TIMESTAMP(3),
  advertiser_id BIGINT,
  campaign_id BIGINT,
  ad_id STRING,
  device_id STRING,
  duplicate_click_count BIGINT,
  refund_amount DECIMAL(10,2),
  original_click_timestamps ARRAY<STRING>,
  detection_window STRING,
  reason STRING,
  compensation_type STRING
) WITH (
  'connector' = 'kafka',
  'topic' = 'compensation-events',
  'properties.bootstrap.servers' = '${KAFKA_BROKERS}',
  'format' = 'json'
);

-- ğŸ›¡ï¸ 5ë¶„ ìœˆë„ìš° ì¤‘ë³µ í´ë¦­ íƒì§€ ë° ë³´ìƒ ì´ë²¤íŠ¸ ë°œí–‰
-- ëª©ì : ê°™ì€ ë””ë°”ì´ìŠ¤ì—ì„œ ê°™ì€ ê´‘ê³ ë¥¼ 5ë¶„ ë‚´ ì—¬ëŸ¬ ë²ˆ í´ë¦­í•œ ê²½ìš° íƒì§€í•˜ì—¬ ìë™ ë³´ìƒ
INSERT INTO compensation_events_sink
SELECT 
  CURRENT_TIMESTAMP as timestamp_field,  -- ë³´ìƒ ì²˜ë¦¬ ì‹œê°„
  advertiser_id,                        -- ë³´ìƒë°›ì„ ê´‘ê³ ì£¼ ID
  campaign_id,                          -- í•´ë‹¹ ìº í˜ì¸ ID
  ad_id,                                -- ì¤‘ë³µ í´ë¦­ëœ ê´‘ê³  ID
  device_id,                            -- ì¤‘ë³µ í´ë¦­í•œ ë””ë°”ì´ìŠ¤ ID
  click_count as duplicate_click_count, -- ì´ ì¤‘ë³µ í´ë¦­ ìˆ˜
  (click_count - 1) * actual_price as refund_amount, -- ğŸ”„ ë³´ìƒ ê¸ˆì•¡ = (ì¤‘ë³µìˆ˜-1) Ã— í´ë¦­ë‹¨ê°€
  click_timestamps as original_click_timestamps,      -- ì›ë³¸ í´ë¦­ ì‹œê°„ ëª©ë¡ (ì¶”ì ìš©)
  '5_MINUTES' as detection_window,      -- íƒì§€ ìœˆë„ìš° í¬ê¸°
  'DUPLICATE_CLICK_DETECTED' as reason, -- ë³´ìƒ ì‚¬ìœ 
  'BALANCE_REFUND' as compensation_type -- ë³´ìƒ ìœ í˜•: ì”ì•¡ í™˜ë¶ˆ

FROM (
  -- ğŸ“Š 5ë¶„ ìœˆë„ìš° ë‚´ ì¤‘ë³µ í´ë¦­ ì§‘ê³„
  SELECT 
    advertiser_id,                      -- ê´‘ê³ ì£¼ ID
    campaign_id,                        -- ìº í˜ì¸ ID
    ad_id,                              -- ê´‘ê³  ID
    device_id,                          -- ë””ë°”ì´ìŠ¤ ID
    actual_price,                       -- ì‹¤ì œ ê³¼ê¸ˆëœ í´ë¦­ ë‹¨ê°€
    COUNT(*) as click_count,            -- í•´ë‹¹ ìœˆë„ìš° ë‚´ ì´ í´ë¦­ ìˆ˜
    -- ğŸ“ í´ë¦­ ì‹œê°„ ëª©ë¡ ìˆ˜ì§‘ (ë””ë²„ê¹… ë° ì¶”ì ìš©)
    COLLECT(DATE_FORMAT(timestamp_field, 'yyyy-MM-dd HH:mm:ss.SSS')) as click_timestamps,
    window_start,                       -- ìœˆë„ìš° ì‹œì‘ ì‹œê°„
    window_end                          -- ìœˆë„ìš° ì¢…ë£Œ ì‹œê°„
    
  FROM TABLE(
    -- â° 5ë¶„ í…€ë¸”ë§ ìœˆë„ìš° (5ë¶„ë§ˆë‹¤ ì¤‘ë³µ íƒì§€)
    TUMBLE(TABLE ad_events_duplicate_source, DESCRIPTOR(timestamp_field), INTERVAL '5' MINUTE)
  )
  WHERE event_type = 'CLICK'            -- í´ë¦­ ì´ë²¤íŠ¸ë§Œ ëŒ€ìƒ
    AND device_id IS NOT NULL           -- ìœ íš¨í•œ ë””ë°”ì´ìŠ¤ ID í•„ìˆ˜
    AND ad_id IS NOT NULL               -- ìœ íš¨í•œ ê´‘ê³  ID í•„ìˆ˜
  GROUP BY 
    advertiser_id, campaign_id, ad_id, device_id, actual_price, window_start, window_end
  HAVING COUNT(*) > 1                   -- ğŸš¨ 2íšŒ ì´ìƒ í´ë¦­ëœ ê²½ìš°ë§Œ ì¤‘ë³µìœ¼ë¡œ íŒì •
) duplicate_clicks;
```
---

## ğŸ—ï¸ **ìµœì í™”ëœ Terraform êµ¬ì„±**

### **âœ… ë‹¨ì¼ Flink Job (4ê°œ Statement í†µí•©)**

```hcl
# ğŸ¯ Flink Compute Pool (í†µí•© ë¦¬ì†ŒìŠ¤)
resource "confluent_flink_compute_pool" "rtb_processor" {
  display_name = "rtb-stream-processor"
  cloud        = "AWS"
  region       = "us-west-2"
  max_cfu      = 20
  
  environment {
    id = confluent_environment.main.id
  }
}

# ğŸ“Š Statement 1: RTB ìºì‹œ ì—…ë°ì´í„°
resource "confluent_flink_statement" "rtb_cache_updater" {
  compute_pool {
    id = confluent_flink_compute_pool.rtb_processor.id
  }
  principal {
    id = confluent_service_account.flink_runner.id
  }
  
  statement = file("${path.module}/sql/rtb_cache_updater.sql")
  properties = {
    "execution.checkpointing.interval" = "30s"
    "parallelism.default" = "4"
  }
  
  rest_endpoint = confluent_flink_compute_pool.rtb_processor.rest_endpoint
  credentials {
    key    = confluent_api_key.flink_api_key.id
    secret = confluent_api_key.flink_api_key.secret
  }
}

# ğŸ“ˆ Statement 2: ì„±ê³¼ ì§‘ê³„
resource "confluent_flink_statement" "performance_aggregator" {
  compute_pool {
    id = confluent_flink_compute_pool.rtb_processor.id
  }
  principal {
    id = confluent_service_account.flink_runner.id
  }
  
  statement = file("${path.module}/sql/performance_aggregator.sql")
  properties = {
    "execution.checkpointing.interval" = "30s"
    "parallelism.default" = "6"
  }
  
  rest_endpoint = confluent_flink_compute_pool.rtb_processor.rest_endpoint
  credentials {
    key    = confluent_api_key.flink_api_key.id
    secret = confluent_api_key.flink_api_key.secret
  }
  
  depends_on = [confluent_flink_statement.rtb_cache_updater]
}

# ğŸ”— Statement 3: ì „í™˜ ë§¤ì¹­  
resource "confluent_flink_statement" "conversion_matcher" {
  compute_pool {
    id = confluent_flink_compute_pool.rtb_processor.id
  }
  principal {
    id = confluent_service_account.flink_runner.id
  }
  
  statement = file("${path.module}/sql/conversion_matcher.sql")
  properties = {
    "execution.checkpointing.interval" = "60s"
    "parallelism.default" = "4" 
    "table.exec.state.ttl" = "25h"  # 24ì‹œê°„ + 1ì‹œê°„ ë²„í¼
  }
  
  rest_endpoint = confluent_flink_compute_pool.rtb_processor.rest_endpoint
  credentials {
    key    = confluent_api_key.flink_api_key.id
    secret = confluent_api_key.flink_api_key.secret
  }
  
  depends_on = [confluent_flink_statement.performance_aggregator]
}

# ğŸ›¡ï¸ Statement 4: ì¤‘ë³µ íƒì§€ & ë³´ìƒ
resource "confluent_flink_statement" "duplicate_detector" {
  compute_pool {
    id = confluent_flink_compute_pool.rtb_processor.id
  }
  principal {
    id = confluent_service_account.flink_runner.id
  }
  
  statement = file("${path.module}/sql/duplicate_detector.sql")
  properties = {
    "execution.checkpointing.interval" = "30s"
    "parallelism.default" = "4"
    "table.exec.state.ttl" = "6h"  # 5ë¶„ ìœˆë„ìš° + 1ì‹œê°„ ë²„í¼
  }
  
  rest_endpoint = confluent_flink_compute_pool.rtb_processor.rest_endpoint
  credentials {
    key    = confluent_api_key.flink_api_key.id
    secret = confluent_api_key.flink_api_key.secret
  }
  
  depends_on = [confluent_flink_statement.conversion_matcher]
}
```
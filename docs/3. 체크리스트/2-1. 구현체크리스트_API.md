# API 서버 구현 체크리스트

> **API 서버 책임 범위**: 
> - HTTP 요청 처리 및 즉시 응답
> - RTB 로직 실행 (광고 매칭/가격 결정)  
> - Redis 기반 선차감 처리
> - Kafka 이벤트 발행 (비동기)
> - **기술 스택**: Kotlin + Spring Boot + Redis + Kafka

---

## 📋 API 목록 및 성능 목표

| 구분         | 엔드포인트                                      | 메서드   | 주요 기능                                     | 목표 응답시간 |
|--------------|------------------------------------------------|----------|-----------------------------------------------|---------------|
| 광고 서빙    | /api/v1/ads/request                            | POST     | 광고 요청(최적 광고 할당, 가격 산정)           | < 50ms        |
| 이벤트 추적  | /api/v1/ads/impression                         | POST     | 노출 이벤트 기록, Kafka 전송                   | < 30ms        |
| 이벤트 추적  | /api/v1/ads/click                              | POST     | Redis 선차감, Kafka 전송                       | < 30ms        |
| 이벤트 추적  | /api/v1/ads/conversion                         | POST     | 전환 이벤트 기록, Kafka 전송                   | < 30ms        |
| 어드민       | /admin/v1/advertisers                          | POST     | 광고주 등록                                   | < 200ms       |
| 어드민       | /admin/v1/advertisers/{id}/balance             | PUT      | 광고주 잔액 충전/차감                         | < 100ms       |
| 어드민       | /admin/v1/advertisers/{id}/balance             | GET      | 잔액/일예산 현황 조회                         | < 100ms       |
| 어드민       | /admin/v1/campaigns                            | POST     | 캠페인 등록                                   | < 200ms       |
| 어드민       | /admin/v1/campaigns/{id}/budget                | GET      | 예산 현황 조회                                | < 100ms       |
| 어드민       | /admin/v1/advertisers/{id}/dashboard           | GET      | 광고주 대시보드                               | < 500ms       |
| 어드민       | /admin/v1/monitoring/realtime                  | GET      | 시스템 실시간 모니터링                        | < 100ms       |

---

## 🚀 광고 서빙 API

### ✅ 1. 광고 요청 API

**📌 API 설명**
```
목적: 사용자의 광고 요청에 대해 실시간으로 최적의 광고를 선택하여 반환
역할: CPC 광고 시스템의 핵심 엔진, RTB(Real-Time Bidding) 처리
입력: 사용자 컨텍스트 (검색어, 카테고리, 디바이스 등)
출력: 최적화된 광고 목록 (가격, 순위 포함)
특징: 50ms 이내 응답, 실시간 예산/잔액 체크, A/B 테스트 지원
```

**🎯 API 구현 체크리스트**
- [ ] **요청 검증**
  - [ ] 필수 파라미터 존재 여부 (기기ID, 세션ID, 배치위치)
  - [ ] 배치위치 값 유효성 검사 (HOME|CATEGORY|SEARCH)
  - [ ] 최대광고수 범위 체크 (1~10)
  - [ ] 실험 키/변수 조합 유효성 검증
  - [ ] 요청 횟수 제한 적용 (rate limiting)

**🔧 RTB 로직 (6단계 상세)**

- [ ] **1단계: 요청 검증 및 전처리**
  ```
  검증 항목:
  - 기기ID: 36자 UUID 형식 확인
  - 세션ID: 세션 유효성 및 만료 시간 체크
  - 배치위치: ENUM 값 검증 (HOME|CATEGORY|SEARCH)
  - 검색어: SEARCH 배치위치인 경우 필수, 2-100자 제한
  - 카테고리: CATEGORY 배치위치인 경우 필수
  - 실험키, 실험변수: 실험 진행 중인 경우 매핑 테이블 존재 확인
  - 최대광고수: 1-10 범위, 기본값 3
  
  전처리:
  - 검색어 정규화 (공백 제거, 소문자 변환)
  - 카테고리 계층 구조 파싱
  - 실험 그룹 할당 검증
  ```

- [ ] **2단계: 후보 캠페인 필터링**
  ```
  검색어 광고 매칭 로직:
  1. 정확 일치 우선 검색
     - Redis: SMEMBERS keyword_exact:{검색어}
     - 최대 50개 캠페인ID 반환
     
  2. 정확 일치 없을 경우 부분 일치
     - Redis: SMEMBERS keyword_partial:{검색어_2gram}
     - 2-gram 토큰 기반 매칭
     - 성능을 위해 최대 100개로 제한
  
  카테고리 광고 매칭 로직:
  1. 리프 카테고리 우선
     - Redis: SMEMBERS category_leaf:{카테고리ID}
     
  2. 상위 카테고리 확장
     - Redis: SMEMBERS category_parent:{상위카테고리ID}
     - 계층별 우선순위 적용
  
  기본 필터링:
  - 캠페인 상태 = 'ACTIVE'
  - 시작일 <= 오늘 <= 종료일
  - 광고주 상태 = 'ACTIVE'
  ```

- [ ] **3단계: 실시간 예산 체크**
  ```
  예산 검증 로직:
  1. 일예산 사용량 조회
     Redis Key: daily_spent:{캠페인ID}:{YYYY-MM-DD}
     - GET으로 현재 사용량 조회
     - 값이 없으면 0으로 간주
     
  2. 예상 비용 계산
     예상비용 = 캠페인입찰가 * 예상클릭률
     
  3. 예산 초과 여부 판단
     if (현재사용량 + 예상비용) > 일예산:
         해당 캠페인 제외
     
  4. 잔액 체크
     Redis Key: balance:{광고주ID}
     if 잔액 < 예상비용:
         해당 캠페인 제외
  ```

- [ ] **4단계: 광고 스코어링 및 랭킹**
  ```
  원본 공식:
  S_α(a,i) = B(a,i) × CTR_π,δ,ω1(a,i) + α × CTR_π,δ,ω1(a,i) × CVR_π,δ,ω2,θ(a,i) × P
  
  풀이:
  광고점수 = 입찰가 × 품질점수 × (클릭률가중치 × 예상클릭률 + 전환률가중치 × 예상전환률)
  
  상세 계산:
  1. 입찰가: 캠페인 입찰가 (원 단위)
  
  2. 품질점수: 광고 품질 점수 (1-10)
     계산 공식:
     품질점수 = (과거클릭률점수 × 0.4) + (과거전환률점수 × 0.3) + (광고품질평가 × 0.3)
     
     세부 계산:
     - 과거클릭률점수 = min(10, (최근30일클릭률 / 업계평균클릭률) × 5)
     - 과거전환률점수 = min(10, (최근30일전환률 / 업계평균전환률) × 5)
     - 광고품질평가 = (크리에이티브품질 + 랜딩페이지품질 + 상품정보완성도) / 3
       * 크리에이티브품질: 이미지 해상도, 텍스트 품질 (1-10)
       * 랜딩페이지품질: 로딩속도, 사용자경험 (1-10)
       * 상품정보완성도: 상품설명, 가격정보, 리뷰 등 (1-10)
     
     최소품질점수: 3.0 (그 이하는 광고 노출 중단)
     신규캠페인품질점수: 5.0 (기본값, 30일 후 실제 계산)
     
  3. 예상클릭률: 과거 30일 클릭률 평균
     - 시간대/요일/디바이스별 보정계수 적용
     - 계절성 트렌드 반영
     
  4. 예상전환률: 과거 30일 전환률 평균
     - 상품 카테고리별 보정계수 적용
     - 가격대별 전환률 보정
     
  5. 가중치 설정
     - 클릭률가중치: 0.6
     - 전환률가중치: 0.4
  
  랭킹:
  - 광고점수 기준 내림차순 정렬
  - 동일 점수시 입찰가 높은 순
  - 최대광고수 개수만큼 선택
  ```

- [ ] **5단계: 가격 결정 (2순위 입찰가 방식)**
  ```
  가격 산정 로직:
  1. 2순위 입찰가 기준
     if (광고 개수 >= 2):
         클릭단가 = min(1순위입찰가, 2순위입찰가 + 1)
     else:
         클릭단가 = min(1순위입찰가, 최소입찰가)
  
  2. 최소 입찰가 적용
     최소입찰가 = 100원 (기본값)
     클릭단가 = max(클릭단가, 최소입찰가)
     
  3. 최대 입찰가 제한
     클릭단가 = min(클릭단가, 1순위입찰가)
     
  4. 가격 검증
     - 음수 방지
     - 정수 단위로 반올림
  ```

- [ ] **6단계: 실험 매핑 처리**
  ```
  실험 상품 매핑 로직:
  1. 실험 참여 확인
     if (실험키 != null && 실험변수 != null):
         실험 매핑 테이블 조회
         
  2. 매핑 테이블 조회
     SELECT 실험상품ID 
     FROM experiment_mapping 
     WHERE 실험키 = ? AND 실험변수 = ? AND 원본상품ID = ?
     AND 상태 = 'ACTIVE'
     AND 시작일 <= NOW() <= 종료일
     
  3. 매핑 적용
     if (매핑 결과 존재):
         응답.상품ID = 실험상품ID
         추적용 원본상품ID 보관
     else:
         응답.상품ID = 원본상품ID
         
  4. 실험 로깅
     - 실험 참여 이벤트 기록
     - 매핑 성공/실패 로그
  ```

- [ ] **응답 생성**
  - [ ] 광고 메타데이터 포함
  - [ ] 추적용 파라미터 생성
  - [ ] 응답 시간 측정 및 포함

---

## 📊 이벤트 추적 API

### ✅ 2. 노출 추적 API

**📌 API 설명**
```
목적: 사용자에게 광고가 실제로 노출되었음을 기록
역할: CTR 계산의 분모 데이터 수집, 광고 성과 측정 기준점
입력: 광고ID, 요청ID, 노출시간
출력: 즉시 성공 응답 (200 OK)
```

**🎯 API 구현 체크리스트**
- [ ] **요청 검증**
  - [ ] 광고ID 존재 및 유효성 검사
  - [ ] 요청ID 매칭 확인
  - [ ] 노출시간 형식 검증

- [ ] **이벤트 처리**
  - [ ] 노출 이벤트 객체 생성
  - [ ] 필수 필드 누락 검사
  - [ ] 이벤트 정규화 처리

- [ ] **Kafka 발행**
  - [ ] ad-events 토픽으로 전송
  - [ ] 발행 실패 시 로깅
  - [ ] 즉시 200 OK 응답

### ✅ 3. 클릭 추적 API

**📌 API 설명**
```
목적: 사용자의 광고 클릭 시 실시간으로 비용을 차감하고 이벤트를 기록
역할: CPC 과금의 핵심, 광고주 잔액에서 즉시 클릭 비용 차감
입력: 광고ID, 기기ID, 클릭시간
출력: 차감 성공/실패 결과, 잔여 잔액 정보
특징: 30ms 이내 응답, Redis 기반 원자적 트랜잭션, 중복 클릭 방지
```

**🎯 API 구현 체크리스트**
- [ ] **중복 클릭 방지**
  - [ ] Redis에 클릭 키 생성 (광고ID + 기기ID + 클릭시간)
  - [ ] SETNX로 중복 체크 (1시간 TTL)
  - [ ] 중복 시 즉시 실패 응답

- [ ] **광고 정보 조회**
  - [ ] 광고ID로 광고 정보 조회
  - [ ] 광고 존재 여부 확인
  - [ ] 캠페인ID, 광고주ID 추출
  - [ ] 클릭 단가 확인

**🔧 Redis 선차감 로직 (MULTI/EXEC 트랜잭션)**

- [ ] **Redis 트랜잭션 처리 상세**
  ```
  1. 트랜잭션 시작
     MULTI
     
  2. 현재 상태 조회 (트랜잭션 큐에 추가)
     잔액키 = "balance:{광고주ID}"
     일예산키 = "daily_spent:{캠페인ID}:{YYYY-MM-DD}"
     
     GET {잔액키}           # 현재 잔액 조회
     GET {일예산키}         # 오늘 사용량 조회
     
  3. 잔액 차감 명령 (트랜잭션 큐에 추가)
     DECRBY {잔액키} {클릭금액}
     
  4. 일예산 카운터 증가 (트랜잭션 큐에 추가)
     INCRBY {일예산키} {클릭금액}
     EXPIRE {일예산키} 86400
     
  5. 트랜잭션 실행
     결과 = EXEC
     
  6. 결과 검증
     if (결과 == null || 결과.isEmpty()):
         트랜잭션 실패 - 재시도 또는 에러
     else:
         원본잔액 = 결과[0]
         일사용량 = 결과[1] 
         신규잔액 = 결과[2]
         
  7. 잔액 부족 체크 (애플리케이션 레벨)
     if (원본잔액 < 클릭금액):
         # 롤백 처리
         MULTI
         INCRBY {잔액키} {클릭금액}     # 잔액 복구
         DECRBY {일예산키} {클릭금액}   # 일예산 복구
         EXEC
         
         return "잔액부족"
  ```

- [ ] **Redis 키 구조 및 데이터 타입**
  ```
  잔액 관리:
  - Key: balance:{광고주ID}
  - Type: STRING (숫자)
  - Value: 현재 잔액 (정수, 원 단위)
  - TTL: 없음 (영구 보관)
  
  일예산 카운터:
  - Key: daily_spent:{캠페인ID}:{YYYY-MM-DD}
  - Type: STRING (숫자)  
  - Value: 오늘 사용 금액 (정수, 원 단위)
  - TTL: 86400초 (24시간)
  
  중복 클릭 방지:
  - Key: click:{광고ID}:{기기ID}:{클릭시간}
  - Type: STRING
  - Value: "1"
  - TTL: 3600초 (1시간)
  
  캠페인 인덱싱:
  - Key: keyword_exact:{키워드}
  - Type: SET
  - Value: 캠페인ID 집합
  
  - Key: category_leaf:{카테고리ID}
  - Type: SET  
  - Value: 캠페인ID 집합
  ```

- [ ] **트랜잭션 실패 처리**
  ```
  실패 시나리오별 대응:
  
  1. Redis 연결 실패
     - 재시도 3회 (100ms, 200ms, 400ms 간격)
     - 최종 실패 시 DB Fallback (성능 저하 감수)
     - Circuit Breaker 상태 업데이트
     
  2. MULTI 실행 실패
     - 즉시 DISCARD로 트랜잭션 취소
     - 에러 로깅 후 재시도
     
  3. EXEC 결과가 null
     - 다른 클라이언트의 키 변경으로 인한 실패
     - 재시도 1회 (Optimistic Lock 특성)
     
  4. 잔액 부족 감지
     - 차감된 금액 즉시 복구
     - 실패 응답 반환
     - 실패 이벤트 Kafka 발행
  ```

- [ ] **응답 처리**
  - [ ] 성공 시: 차감 금액, 남은 잔액 포함
  - [ ] 실패 시: 실패 사유 포함
  - [ ] 즉시 응답 반환 (동기)

- [ ] **Kafka 이벤트 발행** (비동기)
  - [ ] 별도 스레드/코루틴에서 처리
  - [ ] 클릭 이벤트 객체 생성
  - [ ] 차감 성공/실패 상태 포함
  - [ ] 발행 실패 시 로컬 큐 백업

- [ ] **예외 처리**
  - [ ] 잔액 부족 예외
  - [ ] Redis 연결 실패 예외
  - [ ] 트랜잭션 실패 예외
  - [ ] 중복 클릭 예외

### ✅ 4. 전환 추적 API

**📌 API 설명**
```
목적: 사용자의 구매/전환 행동을 광고 클릭과 연결하여 기록
역할: CVR 계산과 광고 효과 측정, ROI 분석의 기준 데이터
입력: 기기ID, 세션ID, 주문 정보
출력: 즉시 성공 응답 (200 OK)
특징: 24시간 내 클릭-전환 매칭, 상품별 전환 추적
```

**🎯 API 구현 체크리스트**
- [ ] **요청 검증**
  - [ ] 기기ID, 세션ID 존재 확인
  - [ ] 상품 정보 배열 검증
  - [ ] 가격 정보 유효성 검사

- [ ] **이벤트 처리**
  - [ ] 24시간 매칭용 세션 정보 포함
  - [ ] 상품별 전환 정보 정리
  - [ ] 전환 이벤트 객체 생성

- [ ] **Kafka 발행**
  - [ ] ad-events 토픽으로 전송
  - [ ] 즉시 200 OK 응답

---

## 🏢 어드민 API

### ✅ 5. 광고주 등록 API

**🎯 API 구현 체크리스트**
- [ ] **입력 검증**
  - [ ] 사업자번호 형식 검증
  - [ ] 이메일 형식 검증
  - [ ] 필수 필드 누락 검사
  - [ ] 사업자번호 중복 검사

- [ ] **데이터 저장**
  - [ ] 광고주 테이블에 저장
  - [ ] 고유 ID 생성
  - [ ] 초기 잔액 설정 (옵션)
  - [ ] 생성 시간 기록

- [ ] **Redis 동기화**
  - [ ] 잔액 정보 Redis에 저장
  - [ ] 광고주 메타데이터 캐싱

### ✅ 6. 잔액 관리 API

**🎯 API 구현 체크리스트**
- [ ] **입력 검증**
  - [ ] action 타입 검증 (charge|deduct)
  - [ ] 금액 양수 검증
  - [ ] 광고주 존재 여부 확인

- [ ] **잔액 처리**
  - [ ] DB 트랜잭션으로 잔액 업데이트
  - [ ] 차감 시 잔액 부족 검사
  - [ ] 변경 이력 테이블에 기록

- [ ] **Redis 동기화**
  - [ ] DB 업데이트 성공 후 Redis 업데이트
  - [ ] 동기화 실패 시 알림

### ✅ 7. 잔액 조회 API

**🎯 API 구현 체크리스트**
- [ ] **데이터 조회**
  - [ ] Redis에서 실시간 잔액 조회
  - [ ] Redis 실패 시 DB Fallback
  - [ ] 일예산 사용량 Redis 조회

- [ ] **응답 생성**
  - [ ] 현재 잔액 포함
  - [ ] 오늘 사용 금액 포함
  - [ ] 마지막 업데이트 시간 포함

### ✅ 8. 캠페인 등록 API

**🎯 API 구현 체크리스트**
- [ ] **입력 검증**
  - [ ] 광고주 존재 여부 확인
  - [ ] 예산 금액 양수 검증
  - [ ] 시작/종료 날짜 유효성 검사
  - [ ] 타겟 키워드 형식 검증

- [ ] **데이터 저장**
  - [ ] 캠페인 테이블에 저장
  - [ ] 타겟팅 조건 저장
  - [ ] 상태를 ACTIVE로 설정

- [ ] **Redis 인덱싱**
  - [ ] 키워드별 캠페인 Set 업데이트
  - [ ] 카테고리별 캠페인 Set 업데이트
  - [ ] 일예산 카운터 초기화

### ✅ 9. 예산 모니터링 API

**🎯 API 구현 체크리스트**
- [ ] **실시간 데이터 조회**
  - [ ] Redis에서 오늘 사용금액 조회
  - [ ] 시간당 소진율 계산
  - [ ] 예상 완료 시간 계산

- [ ] **알림 체크**
  - [ ] 80%, 90%, 95% 임계치 확인
  - [ ] 알림 이력 조회
  - [ ] 자동 일시정지 조건 체크

### ✅ 10. 대시보드 API

**🎯 API 구현 체크리스트**
- [ ] **권한 검증**
  - [ ] 광고주 소유권 확인
  - [ ] 접근 권한 검사

- [ ] **데이터 집계**
  - [ ] 캐시된 집계 데이터 우선 조회
  - [ ] 실시간 Redis 카운터 조회
  - [ ] 기간별 성과 데이터 계산
  - [ ] CTR, CVR, CPC 계산

- [ ] **캐시 관리**
  - [ ] 5분 TTL로 결과 캐싱
  - [ ] 캐시 키 생성 규칙
  - [ ] 캐시 무효화 조건

### ✅ 11. 실시간 모니터링 API

**🎯 API 구현 체크리스트**
- [ ] **권한 검증**
  - [ ] 관리자 권한 확인

- [ ] **시스템 메트릭 수집**
  - [ ] API 응답 시간 집계
  - [ ] 처리량(TPS) 계산
  - [ ] 에러율 계산
  - [ ] 잔액 차감 성공률 계산

- [ ] **헬스 체크**
  - [ ] Redis 연결 상태 확인
  - [ ] Kafka 연결 상태 확인
  - [ ] DB 연결 풀 상태 확인
  - [ ] 메모리 사용률 확인

---

## 🚨 공통 구현 체크리스트

### ✅ 12. 예외 처리

**🔧 필수 예외 처리**
- [ ] **잔액 부족 예외**
  - [ ] 명확한 에러 메시지
  - [ ] 현재 잔액 정보 포함
  - [ ] 로깅 처리


### ✅ 13. 모니터링 및 로깅

**🔧 필수 모니터링**


- [ ] **비즈니스 메트릭**
  - [ ] 잔액 차감 성공률
  - [ ] 광고 매칭 성공률
  - [ ] 예산 소진율
  - [ ] 실험 참여율



# CPC 광고 시스템 기획 v1 - 전체 요약 정리

## 1. 개발 배경 및 방향성

**타임라인:**
- 2023.3Q 초: Citrus Ad 오픈소스 도입
- 2025.4Q 목표: 자체 CPC 광고 시스템 구축

**개발 목적:**
- 회사 자체 수수료 구조 개선
- 개발 대기시간 단축
- Citrus Ad의 기본 관리 기능 대체

## 2. 개발 범위 (1차)

**핵심 구성요소:**
- RTB (Real-Time Bidding) 엔진
- 노출 API
- 어드민 시스템

**요구사항:**
- Citrus Ad와 동일한 구성 및 구현
- 기존 성과 이상의 RTB 엔진 구축
- 확장성: 가격 실험/개인화 대응

---

## A. 프론트 API 구성

### 광고 영역
- **홈**: 1차 카테고리 기준
- **상품상세**
- **카테고리**: 1~4차까지 지원
- **검색어**: 수동 심사 진행

### Request API
**필수 파라미터:**
- `deviceID`, `sessionID`, `placement`, `searchterm`, `category`, `userID`, `exp_key`, `exp_var`, `maxNumOfAds`

**응답 결과:**
- `[productID, ad_ID]` 배열

### Tracking API (노출/클릭)
**파라미터:**
- `ad_ID`

**호출 시점:**
- **노출시**: RTB에서 각 노출 광고의 정확한 기록
- **클릭시**: 적용가 차감 + 로깅

**사전 매핑 정보:**
- 캠페인ID, 영역, 상품, 입찰가, 적용가

### 구매 트래킹 API
**필수 파라미터:**
- `deviceID`, `sessionID`, `orderDate`, `[productID, quantity, unitPrice, discountedPrice]`

**기여 매출 집계 기준:**
- 클릭 후 24시간 내 주문만 인정
- 세션 내 발생한 가장 최근 클릭 광고에 기여
- 중복 배분 시 클릭 수 기반 가중평균 적용

---

## B. 어드민 (광고주 및 관리자 인터페이스)

### 주요 탭 구성
- 광고주 / 캠페인 / 대시보드 / 보고서 / 관리자

### 기능 요약

**광고주 관리:**
- 등록/조회/상세/잔액 충전/차감/사용자 초대/계정 관리

**캠페인 관리:**
- **등록 단계**: 타입&영역 → 상품 → 키워드 → 입찰가/예산
- 리스트 조회 & 관리자 승인/거절

**성과 분석:**
- ROAS, 전환율, CPC, 기여매출 등 지표 집계
- CSV 다운로드 지원

---

## C. RTB 엔진 설계

RTB 엔진은 **광고 할당(allocation)**과 **가격 산정(pricing)**의 2가지 요소로 구성됩니다.

### 1. 광고 할당 (Allocation)

**목적:** 광고 영역 a의 n번째 위치에 적합한 광고를 할당

**할당 알고리즘:**
```
Allocation (a,n) = rank(n) of R(S_α(a,i))
```

**함수 정의:**
- `R(a)`: 광고 영역 a에 해당하는 모든 광고 i에 대해서 노출 점수 S_α에 따라 정렬하는 함수

**노출 점수 계산:**
```
S_α(a,i) = B(a,i) × CTR_π,δ,ω1(a,i) + α × CTR_π,δ,ω1(a,i) × CVR_π,δ,ω2,θ(a,i) × P
```

**변수 정의:**
- `B(a,i)`: 광고 영역 × 상품별로 광고주가 입력한 입찰가
- `CTR_π,δ,ω1(a,i)`: 엔진 추정치로 최근 π 기간 동안 a영역에서 i 상품의 노출 대비 클릭율
- `CVR_π,δ,ω2,θ(a,i)`: 엔진 추정치로 최근 π 기간 동안 a영역에서 i 상품의 클릭 대비 구매율
- `P`: 상품 관련 가중치
- `α`: 전환율 가중치 파라미터

**후처리:**
```
Post-processing(Allocation(a,n))
```
- 최종적으로 "후처리"를 거친 상품 코드를 할당

### 2. 가격 산정 (Pricing)

**목적:** 광고 영역 a의 n번째 위치의 CPC 적용가 산정

**가격 산정 알고리즘:**
```
Pricing(a,n) = min(B(a,n), B(a,n+1))
```

**특수 케이스:**
- 품질 점수가 낮아서 입찰가가 역전되는 경우, 자신의 입찰가를 사용

**적용 방식:**
- 클릭 시 차감을 진행하기 위해, 노출 시 산정된 적용가가 반영 필요
- Request API에서 가격 기록
- Tracking API에서 적용가 반영한 logging 및 잔액 차감 필요

### 3. 파라미터 관리

**초기 설정:**
- 파라미터 `α`, `π`는 기존 시스템의 세팅으로 런칭
- 추후 고도화를 위해서 변경 가능한 구조 필요

### 필터링 요건
- 잔액 > 0
- 승인/유효 캠페인
- 일예산 초과 없음
- 품절 상품 제외

### 방어로직
**CTR, CVR 값 부족 시 평균값 적용:**
- `⍵1` (노출 임계): 1시간 평균 이하 시 CTR = 방어값
- `⍵2` (클릭 임계): 1시간 평균 이하 시 CVR = 방어값
- `δ`: 방어값 추정법 (평균 or 최소)

---

## D. 데이터 설계

### 테이블 요약

**광고주:**
- 기본정보, 잔액

**캠페인:**
- 광고주, 영역, 상품, 입찰가, 일예산 등

**로그 테이블:**
- **노출**: session, 영역, 상품, 입찰가, 적용가, 순위
- **클릭**: session, 영역, 상품, 클릭시간, 적용가
- **주문**: session, 상품, 수량, 금액
- **잔액 변경**: 시간, 금액, 담당자

### 특이사항
- 가격/입찰가는 실시간 DB 접근 필요
- 주문 이력 = 클릭 이후 발생 건만 집계
- 전환 매출 분배 시 클릭 수 기준 가중 평균

---

## E. Migration 계획

- Citrus Ad 시스템에서 기존 데이터 동기화 모듈 개발
- 초기 파라미터 추정 작업 수행
- A/B 테스트로 기존 대비 성능 검증 예정

---

## F. 확장 요건

### 가격 실험
- 실험 키(`exp_key`), 실험군(`exp_var`) 기반 상품 코드 변환 필요
- 클릭/구매 로그에 실험 정보 태깅 필수

### 개인화
- **Lv1**: 클릭 recency, 노출 frequency 기반 retargeting
- **Lv2**: 유저별 CTR/CVR 추정
- **Lv3**: 머신러닝 모델 확장 가능성 고려 (현재는 보류)


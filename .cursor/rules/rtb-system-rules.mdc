---
description: 
globs: 
alwaysApply: false
---
# 🚀 RTB System Development Rules

## 🎯 RTB 시스템 핵심 원칙

### 성능 최우선
RTB 시스템은 광고 (Api + Worker) + Flink 기반으로 이뤄지며 캠페인, 정산 등은 판매자어드민(Api, Worker, Batch)에서 구현됩니다.

## 📊 문서 기반 개발 프로세스

### 요구사항 검증 우선순위
1. **RTB 요구사항**: [1-3 RTB_요구사항.md](mdc:docs/1. 정리/1-3 RTB_요구사항.md)가 최우선
2. **일반 요구사항**: [1-2. 요구사항.md](mdc:docs/1. 정리/1-2. 요구사항.md)와 조화
3. **용어 정의**: [1-1. 용어사전.md](mdc:docs/1. 정리/1-1. 용어사전.md) 기준 준수

### 설계 검증 체계
1. **아키텍처 우선**: [2-2. 아키텍처.md](mdc:docs/2. 설계/2-2. 아키텍처.md)의 3-5ms 최적화 전략 준수
2. **데이터 모델**: [2-3. 광고_테이블_설계.md](mdc:docs/2. 설계/2-3. 광고_테이블_설계.md)의 ERD 기반 구현
3. **스트림 처리**: [2-4. 광고_토픽_설계.md](mdc:docs/2. 설계/2-4. 광고_토픽_설계.md)의 토픽 구조 준수
4. **업무 플로우**: [2-1. 업무흐름.md](mdc:docs/2. 설계/2-1. 업무흐름.md) 비즈니스 로직 반영

## 🔧 구현 단계별 규칙

### API 개발 ([3-2. 구현체크리스트_API.md](mdc:docs/3. 체크리스트/3-2. 구현체크리스트_API.md))
- **Redis 캐시 우선**: 95% Cache Hit 목표
- **응답 시간**: 모든 광고 조회 API는 3-5ms 내 응답
- **동시성 처리**: 초당 10,000+ 요청 처리 능력
- **실시간 잔액 관리**: 클릭 시 즉시 CPC 차감

### Flink 스트림 처리 ([3-3. 구현체크리스트_Flink.md](mdc:docs/3. 체크리스트/3-3. 구현체크리스트_Flink.md))
- **통합 처리**: RTB 계산 + 클릭 처리 + 전환 처리 단일 태스크
- **24시간 윈도우**: 클릭-전환 매칭 정확도 99.9%
- **실시간 집계**: CTR, CVR, ROAS 5분 윈도우 계산
- **비용 최적화**: Confluent Flink 단일 태스크로 60-80% 비용 절감

### Worker 배치 처리 ([3-4. 구현체크리스트_Worker.md](mdc:docs/3. 체크리스트/3-4. 구현체크리스트_Worker.md))
- **성과 리포트**: 일/주/월 단위 집계
- **정산 처리**: 정확한 광고비 계산
- **데이터 동기화**: DB와 Redis 간 일관성 유지

### 선행데이터 준비 ([3-1. 선행데이터_체크리스트.md](mdc:docs/3. 체크리스트/3-1. 선행데이터_체크리스트.md))
- **정책 결정**: 주문 취소, 중복 주문 등 예외 시나리오 대응
- **마스터 데이터**: 광고주, 상품, 카테고리 기초 데이터
- **테스트 데이터**: 성능 테스트용 대용량 데이터 준비

## 🚨 변경 영향도 매트릭스

### 요구사항 변경 시 필수 업데이트
| 변경 문서 | API | Flink | Worker | 테이블 | 토픽 | 아키텍처 |
|----------|-----|-------|--------|--------|------|----------|
| RTB_요구사항 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 요구사항 | ⚠️ | ⚠️ | ⚠️ | ⚠️ | ⚠️ | ✅ |
| 용어사전 | ⚠️ | ⚠️ | ⚠️ | ⚠️ | ⚠️ | ⚠️ |

### 설계 변경 시 필수 업데이트
| 변경 문서 | API | Flink | Worker |
|----------|-----|-------|--------|
| 아키텍처 | ✅ | ✅ | ✅ |
| 테이블_설계 | ✅ | ⚠️ | ✅ |
| 토픽_설계 | ⚠️ | ✅ | ⚠️ |
| 업무흐름 | ✅ | ✅ | ⚠️ |

범례: ✅ 필수 업데이트 | ⚠️ 검토 후 필요시 업데이트

## 🔍 핵심 검증 포인트

### 비즈니스 로직 검증
- **RTB 알고리즘**: S_α(a,i) = B(a,i) × CTR + α × CTR × CVR × P 정확성
- **수익률 계산**: revenue_amount 기반 ROAS 정확성
- **전환 매칭**: 24시간 윈도우 내 클릭-구매 연결
- **잔액 관리**: 실시간 CPC 차감 정확성

### 데이터 일관성 검증
- **Redis-DB 동기화**: 캐시와 DB 간 데이터 일치성
- **Kafka 순서 보장**: 이벤트 처리 순서 보장
- **중복 처리 방지**: 동일 이벤트 중복 처리 방지
- **장애 복구**: 시스템 장애 시 데이터 복구 능력

## 📝 코드 리뷰 체크리스트

### 필수 확인 사항
1. **문서 기반 구현**: 해당 체크리스트 문서와 일치하는가?
2. **성능 목표**: 3-5ms 응답시간 목표 달성 가능한가?
3. **에러 처리**: 모든 예외 상황 처리 구현되었는가?

### 특별 검토 항목
- **Redis 캐시 전략**: 효율적인 캐시 키 설계와 TTL 설정
- **Kafka 프로듀서/컨슈머**: 적절한 파티션 및 오프셋 관리
- **DB 인덱스**: 테이블 설계 문서의 인덱스 전략 준수
- **API 응답**: 일관된 응답 형식과 에러 코드 사용
